<?xml version="1.0" encoding="utf-8"?>
<OneStreamXF version="6.8.1.13230">
    <extensibilityRulesRoot>
        <businessRule businessRuleType="Extender" name="Email_Helper">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies>
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_Models" />
            </referencedAssemblies>
            <sourceCode><![CDATA[Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database

Imports System.Xml
Imports Newtonsoft.Json

Imports OneStream.BusinessRule.Extender.OS_Models

Namespace OneStream.BusinessRule.Extender.Email_Helper
	Public Class MainClass
		
		#Region "Settings"
			'Define 'company colors' for the title bar
	        Public _foreColor As String = "#FFB81C" 
			Public _backColor As String = "#0072CE"
			
			'Automation phrase - must match automation business rule
			Public _automationPhrase As String = "automate"
		
		#End Region
		
		#Region "Dev Only"
			Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As ExtenderArgs) As Object
	            Try
	                Return Nothing
	            Catch ex As Exception
	                Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
	            End Try
	        End Function
		#End Region
		
		Public Sub GetBatchDetailsAndSendEmail(ByVal si As SessionInfo, ByVal batchInfo As WorkflowBatchFileCollection, ByVal distributionList As List(Of String), ByVal subjectPreText As String, ByVal bodyPreText As String, ByVal emailServer As String, ByVal dmJobName As String)
			Dim fileAttachmentPaths As New List(Of String)
			
			Try
				
				Dim subject As String = subjectPreText & $"- Batch Detail Report for DM Job {dmJobName}"
				Dim eResult As New EmailResults
				
				If Not batchInfo Is Nothing Then					
					Using objDbConnInfoApp As DbConnInfoApp = BRApi.Database.CreateApplicationDbConnInfo(si)
						For Each kvp As keyValuePair(Of Integer, List(Of WorkflowBatchFileInfo)) In batchInfo.FileGroups							
							For Each wfBatchInfo As WorkflowBatchFileInfo In kvp.Value
								
								Dim importStatus As String = "N/A"
								Dim transformationStatus As String = "N/A"
								Dim intersectionStatus As String = "N/A"
								Dim loadStatus As String = "N/A"
								Dim processCubeStatus As String = "N/A"
								Dim fullFilePathName As String = "N/A"
								
								Dim wfPOVId As String = $"{wfBatchInfo.ProfileInfo.Name.ToUpper}_{ScenarioDimHelper.GetNameFromId(si, wfBatchInfo.CurrentWorkflowUnitPk.ScenarioKey).ToUpper}_{TimeDimHelper.GetNameFromId(wfBatchInfo.CurrentWorkflowUnitPk.TimeKey).ToUpper}"
								
								Dim response As ResponseStatus = Nothing
								Try
									Dim objXFUserState As XFUserState = BRApi.State.GetSessionState(si, False, ClientModuleType.External, String.Empty, String.Empty, wfPOVId + "_response", String.Empty)
									If objXFUserState IsNot Nothing Then
										 response  = JsonConvert.DeserializeObject(Of ResponseStatus)(objXFUserState.TextValue)
									End If
								Catch
								End Try
																
								Dim updatedWorkflowUnitPksCount As Integer = 0
								For Each batchWFUnitPk As WorkflowUnitPk In wfBatchInfo.ProcessInfo.UpdatedWorkflowUnitPks
									updatedWorkflowUnitPksCount += 1
									
									Dim wfName As String = BRApi.Workflow.Metadata.GetProfile(si, batchWFUnitPk.ProfileKey).Name									
									Dim wfInfoStatus As WorkflowInfo = BRApi.Workflow.Status.GetWorkflowStatus(si, batchWfUnitPk)

									importStatus = If(response IsNot Nothing, If(response.Success, $"Completed with {response.FcpRecordCount} rows received from FCP and {response.OsRecordCount} rows loaded to OneStream.", importStatus), _
														$"{wfInfoStatus.GetStepStatus(StepClassificationTypes.DataLoadTransform).ToString} and {wfBatchInfo.ProcessInfo.RowCount} rows loaded to OneStream.")
									transformationStatus = wfInfoStatus.GetStepStatus(StepClassificationTypes.ValidateTransform).ToString
									intersectionStatus = wfInfoStatus.GetStepStatus(StepClassificationTypes.ValidateIntersection).ToString
									loadStatus = wfInfoStatus.GetStepStatus(StepClassificationTypes.LoadCube).ToString
									processCubeStatus = wfInfoStatus.GetStepStatus(StepClassificationTypes.ProcessCube).ToString
									
									If Not wfInfoStatus.GetStepStatus(StepClassificationTypes.ValidateTransform).Equals(WorkflowStatusTypes.Completed) Then
										'Generate Validation Error Report
										fullFilePathName = BRApi.FileSystem.GetFileShareFolder(si, FileShareFolderTypes.ApplicationOutgoing, Nothing) & "\" & wfPOVId & "_ValidationErrors.html"
										
										If wfBatchInfo.ValTransProcessInfoErrors.ContainsKey(batchWFUnitPk.CreateWorkflowUnitClusterPk) Then
											If Me.GenerateValidationReport(si, wfBatchInfo.ValTransProcessInfoErrors.Item(batchWFUnitPk.CreateWorkflowUnitClusterPk), fullFilePathName) Then
												fileAttachmentPaths.Add(fullFilePathName)
												transformationStatus += $" - See Attachement {wfPOVId}_ValidationErrors.html" 
											Else
												transformationStatus += "Report was not creataed but validation errors were found"
											End If
										End If
									End If
									
									If Not wfInfoStatus.GetStepStatus(StepClassificationTypes.ValidateIntersection).Equals(WorkflowStatusTypes.Completed) Then
										'Generate Intersection Validation Error Report
										fullFilePathName = BRApi.FileSystem.GetFileShareFolder(si, FileShareFolderTypes.ApplicationOutgoing, Nothing) & "\" & wfPOVId & "_IntersectionErrors.html"
										
										If wfBatchInfo.ValIntersectProcessInfoErrors.ContainsKey(batchWFUnitPk.CreateWorkflowUnitClusterPk) Then
											Dim intErrCount As Integer = Me.CheckIntersectionErrorCount(si, objDbConnInfoApp, batchWFUnitPk)
											If intErrCount < 0 Then 'Error occurred
												intersectionStatus = $"Error occurred getting intersection error count."
											ElseIf intErrCount < 150 Then
												If Me.GenerateIntersectionReport(si, objDbConnInfoApp, batchWFUnitPk, fullFilePathName) Then
													intersectionStatus = $"{intErrCount} Intersection Errors generated</br><b>See {wfPOVId}_IntersectionErrors.html for more details</b>"
													fileAttachmentPaths.Add(fullFilePathName)
												Else
													intersectionStatus = $"Report failed to generate but {intErrCount} intersection errors were found"
												End If
											Else
												intersectionStatus = $"Report was not creataed. Too many errors to report. {intErrCount} intersection errors were found."
											End If											
										End If
									End If
									
									Dim status As String
									If Not wfBatchInfo.FileProcessed Then
										status = "Fail"
									Else
										status = "Success"
									End If
									Dim firstName As String = String.Empty 
									Dim lastName As String = String.Empty 
									GetUserDescription(si,firstName,lastName)'DPA-29476/vn50tv8/DEC 29th 2021	
									eResult.Add(si, _
												$"{wfBatchInfo.ProfileInfo.Name}</br>{wfBatchInfo.TimeName}</br>{wfBatchInfo.ScenarioName}", _
												status, _
												importStatus, _
												transformationStatus, _
												intersectionStatus, _
												loadStatus, _
												processCubeStatus, _
												$"{firstName}</br>{lastName}")'DPA-29476/vn50tv8/DEC 29th 2021	
								Next
								If updatedWorkflowUnitPksCount = 0 Then
									'Import error - Check if SessionStage is available
									Try
										Dim objXFUserState As XFUserState = BRApi.State.GetSessionState(si, False, ClientModuleType.External, String.Empty, String.Empty, wfPOVId, String.Empty)
										If objXFUserState IsNot Nothing Then
											If objXFUserState.TextValue.XFContainsIgnoreCase("Could not get data from FCP") Or objXFUserState.TextValue.XFContainsIgnoreCase("ERROR") Then
												
												'Save the Connection Log to file
												fullFilePathName = BRApi.FileSystem.GetFileShareFolder(si, FileShareFolderTypes.ApplicationOutgoing, Nothing) & "\" & wfPOVId & "_GET-LOG.txt"
												
												Using fdxDataFile As System.IO.StreamWriter = New StreamWriter(fullFilePathName, False)
													fdxDataFile.Write(objXFUserState.TextValue)
													fdxDataFile.Close									
												End Using
																
												fileAttachmentPaths.Add(fullFilePathName)
												
												importStatus = $"Import failed. See attachement {wfPOVId}_GET-LOG.txt for more info."
											Else
												importStatus = "Failed"
											End If
										Else
											importStatus = "Failed"
										End If
									Catch
										importStatus = "Failed"
									End Try
									
									If response IsNot Nothing Then
										If Not response.Success Then
											importStatus = $" {importStatus} </br> Summary: {response.StatusCode} - {response.ReasonPhrase}"
										End If
									End If
									Dim firstName As String = String.Empty 
									Dim lastName As String = String.Empty 
									GetUserDescription(si,firstName,lastName)'DPA-29476/vn50tv8/DEC 29th 2021	
									eResult.Add(si, _
												$"{wfBatchInfo.ProfileInfo.Name}</br>{wfBatchInfo.TimeName}</br>{wfBatchInfo.ScenarioName}", _
												"Fail", _
												importStatus, _
												"N/A", _
												"N/A", _
												"N/A", _
												"N/A", _
												$"{firstName}</br>{lastName}")'DPA-29476/vn50tv8/DEC 29th 2021	
								End If
							Next
						Next
					End Using
				End If
									
				Dim body As New StringBuilder
				Dim rowHeaders As New List(Of String)
				rowHeaders.Add("Workflow Info")
				rowHeaders.Add("Batch Status")
				rowHeaders.Add("Import Status")
				rowHeaders.Add("Transformation Status")
				rowHeaders.Add("Intersection Status")
				rowHeaders.Add("Load Cube Status")
				rowHeaders.Add("Process Cube Status")
				rowHeaders.Add("Triggered By")'DPA-29476/vn50tv8/DEC 29th 2021	
				
				body.AppendLine(bodyPreText)
				body.AppendLine(StartHTMLTable)
				body.AppendLine(NewHTMLTableRowHeader(rowHeaders))
				Dim r As Integer = 0
				Dim rowValues As New List(Of String)
	            For Each rslt As EmailResult In eResult.Results
					rowValues.Add(rslt.wfDetails)
					rowValues.Add(rslt.Status)
					rowValues.Add(rslt.ImportStatus)
					rowValues.Add(rslt.TransformationStatus)
					rowValues.Add(rslt.IntersectionStatus)
					rowValues.Add(rslt.LoadStatus)
					rowValues.Add(rslt.ProcessCubeStatus)
					rowValues.Add(rslt.TriggeredBy)'DPA-29476/vn50tv8/DEC 29th 2021	
					body.AppendLine(NewHTMLTableRow((rowValues)))
					rowValues.Clear
	            Next
	    	    body.AppendLine(EndHTMLTable)
	            					
				BRApi.Utilities.SendMail(si, emailServer, distributionList, subject, body.ToString, True, fileAttachmentPaths)
				
			Catch ex As Exception
				brapi.ErrorLog.LogMessage(si, ex.Message)
			Finally
				'Delete file attachement(s) from FileShare
				For Each fileFullName As String In fileAttachmentPaths
					File.Delete(fileFullName)
				Next
			End Try
		End Sub
		
		Public Sub SendRequestsInitiatedEmail(ByVal si As SessionInfo, ByVal requests As DataTable, ByVal fileAttachmentPaths As List(Of String),
											  ByVal subjectPreText As String, ByVal bodyPreText As String, ByVal appName As String, ByVal paramEmailServer As String, 
											  ByVal distributionList As List(Of String), Optional ByVal err As List(Of String) = Nothing,Optional ByVal wrn As List(Of String) = Nothing,
											  Optional ByVal autoCommit As Boolean = False)
			
			'Set up additional info string
			Dim addInfo As String = $"Ran on {subjectPreText}</br>FCP data from {appName}"
					
			'Subject
			Dim subject As String = $"{subjectPreText} - ACM Metadata Import Status"
					
			'Body
			Dim body As New StringBuilder
			
			If requests IsNot Nothing And requests.Rows.Count > 0 Then
				body.AppendLine(bodyPreText)
				body.AppendLine(NewHTMLParagraph("Metadata Import/Stage Complete."))
				body.AppendLine(NewHTMLParagraph(addInfo))
				body.AppendLine(StartHTMLTable)
				body.AppendLine(NewHTMLTableRowHeader(requests.Columns.Cast(Of DataColumn).Select(Function(x) x.ColumnName).ToList()))
				For Each requestRow As DataRow In requests.rows
					body.AppendLine(NewHTMLTableRow(requestRow.ItemArray.Cast(Of String).Select(Function(x) x.ToString).ToList()))
				Next
				body.AppendLine(EndHTMLTable)
				If Not autoCommit Then body.AppendLine(NewHTMLParagraph("Pending Review and Commit."))
				
				If wrn IsNot Nothing And wrn.Count > 0 Then
					Dim wrnText As String = "<span style='color:#FFC300'>Note(s):</span>"
					For Each w As String In wrn
						wrnText += "</br>" & w
					Next
					body.AppendLine(NewHTMLParagraph(wrnText))
				End If
				
				If err IsNot Nothing And err.Count > 0 Then
					Dim errText As String = "<span style='color:#ff030b'>Error(s):</span>"
					For Each e As String In err
						errText += "</br>" & e
					Next
					body.AppendLine(NewHTMLParagraph(errText))
				End If
				
'				If err <> "" Then
'					body.AppendLine(NewHTMLParagraph($"<span style='color:#ff030b'>ERROR:</span> {err}"))
'				End If
			Else

				'Show completion if no error
				If err Is Nothing Or err.Count = 0 Then
					body.AppendLine(NewHTMLParagraph($"Metadata Import/Stage Complete."))
					body.AppendLine(NewHTMLParagraph(addInfo))
					body.AppendLine(NewHTMLParagraph($"No changes found.</br>No request generated."))
				End If
				
				' Add any warnings
				If wrn IsNot Nothing And wrn.Count > 0 Then
					Dim wrnText As String = "<span style='color:#FFC300'>Warning:</span>"
					For Each w As String In wrn
						wrnText += "</br>" & w
					Next
					body.AppendLine(NewHTMLParagraph(wrnText))
				End If				
				
				' Add any errors
				If err IsNot Nothing And err.Count > 0 Then
					body.AppendLine(NewHTMLParagraph(addInfo))
					Dim errText As String = "<span style='color:#ff030b'>Error:</span>"
					For Each e As String In err
						errText += "</br>" & e
					Next
					body.AppendLine(NewHTMLParagraph(errText))					
				End If				
			End If
			
			'Send email
			BRApi.Utilities.SendMail(si, paramEmailServer, distributionList, subject, body.ToString, True, fileAttachmentPaths)
			
		End Sub
		Public Sub SendRequestsInitiatedEmail(ByVal si As SessionInfo, ByVal requests As DataTable, ByVal fileAttachmentPaths As List(Of String),
											  ByVal envName As String, ByVal appName As String, ByVal paramEmailServer As String, ByVal distributionList As List(of String), 
											  Optional ByVal err As String = "")

			'Get current environenment
			Dim xEnv As New XFEnvironment
			Dim xSet As XFEnvironmentSettings = xEnv.GetAppServerConfigEnvironmentSettings()
			Dim curEnvName As String = xSet.EnvironmentName
			
			'Set up additional info string
			Dim addInfo As String = $"Ran on: {curEnvName} - {si.AppName}</br>Data from: {envName} - {appName}"
					
			'Subject
			Dim subject As String = $"ACM Metadata Import Status - {si.AppName}"
					
			'Body
			Dim body As New StringBuilder
			
			If requests IsNot Nothing And requests.Rows.Count > 0 Then
				body.AppendLine(NewHTMLParagraph("Metadata Import/Stage Complete."))
				body.AppendLine(NewHTMLParagraph(addInfo))
				body.AppendLine(StartHTMLTable)
				body.AppendLine(NewHTMLTableRowHeader(requests.Columns.Cast(Of DataColumn).Select(Function(x) x.ColumnName).ToList()))
				For Each requestRow As DataRow In requests.rows
					body.AppendLine(NewHTMLTableRow(requestRow.ItemArray.Cast(Of String).Select(Function(x) x.ToString).ToList()))
				Next
				body.AppendLine(EndHTMLTable)
				body.AppendLine(NewHTMLParagraph("Pending Review and Commit."))
			Else
				If err <> "" Then
					body.AppendLine(NewHTMLParagraph($"Error importing metadata."))
					body.AppendLine(NewHTMLParagraph(addInfo))
					body.AppendLine(NewHTMLParagraph(err))
				Else
					body.AppendLine(NewHTMLParagraph($"Metadata Import/Stage Complete."))
					body.AppendLine(NewHTMLParagraph(addInfo))
					body.AppendLine(NewHTMLParagraph($"No changes found.</br>No request generated."))
				End If
			End If
			
			'Send email
			BRApi.Utilities.SendMail(si, paramEmailServer, distributionList, subject, body.ToString, True, fileAttachmentPaths)
			
		End Sub
		Public Sub SendDataTableEmail(ByVal si As SessionInfo, ByVal subject As String, ByVal dt As DataTable, ByVal distributionList As List(Of String), ByVal emailServer As String,
										Optional ByVal fileAttachmentPaths As List(Of String) = Nothing,
										Optional ByVal preParagraph As String = "",
										Optional ByVal postParagraph As String = "")
			'Build Body
			Dim body As New StringBuilder
			If dt IsNot Nothing And dt.Rows.Count > 0 Then
				If preParagraph <> "" Then body.AppendLine(NewHTMLParagraph(preParagraph))
				body.AppendLine(StartHTMLTable)
				body.AppendLine(NewHTMLTableRowHeader(dt.Columns.Cast(Of DataColumn).Select(Function(x) x.ColumnName).ToList()))
				For Each requestRow As DataRow In dt.rows
					body.AppendLine(NewHTMLTableRow(requestRow.ItemArray.Cast(Of String).Select(Function(x) x.ToString).ToList()))
				Next
				body.AppendLine(EndHTMLTable)
				If postParagraph <> "" Then body.AppendLine(NewHTMLParagraph(postParagraph))
			Else
				body.AppendLine(NewHTMLParagraph("No data found"))
			End If
			
			'Attachments
			If fileAttachmentPaths Is Nothing Then fileAttachmentPaths = New List(Of String)({""})
				
			'Send
			BRApi.Utilities.SendMail(si,emailServer,distributionList,subject,body.ToString,True,fileAttachmentPaths)
			
		End Sub

				
		Public Function GenerateValidationReport(ByVal si As SessionInfo, ByVal valProcessInfo As ValidationTransformationProcessInfo, ByVal fullFilePathName As String) As Boolean
			Try
				Dim unMappedItemsFound As Boolean
				
				Dim body As New StringBuilder
				body.AppendLine(StartHTMLTable)
				
				Dim rowHeaders As New List(Of String)
				rowHeaders.Add("Dimension")
				rowHeaders.Add("Source Value")
				rowHeaders.Add("Output Value")
				
				body.AppendLine(NewHTMLTableRowHeader(rowHeaders))
				For Each kvpDimValInfo As KeyValuePair(Of String, DimensionValidationInfo) In valProcessInfo.DimensionValidationInfos
					For Each valErrorItem As DimensionValidationErrorItemInfo In kvpDimValInfo.Value.UnmappedItems
						unMappedItemsFound = True
						Dim rowValues As New List(Of String)
						rowValues.Add(kvpDimValInfo.Key)
						rowValues.Add(valErrorItem.RuleName)
						rowValues.Add(valErrorItem.OutputValue)
						body.AppendLine(NewHTMLTableRow((rowValues)))
					Next
				Next
				body.AppendLine(EndHTMLTable)
				
				If unMappedItemsFound Then
					Using fdxDataFile As System.IO.StreamWriter = New StreamWriter(fullFilePathName, True)
						fdxDataFile.Write(body)
						fdxDataFile.Close									
					End Using
					
					Return True
				Else
					Return False
				End If
				
			Catch ex As Exception
				'Error
				brapi.ErrorLog.LogMessage(si, $"Exception generating validation report. {ex.Message}")
				Return False
			End Try
		End Function
		Public Function CheckIntersectionErrorCount(ByVal si As SessionInfo, ByVal objDbConnInfoApp As DbConnInfoApp, ByVal currentWorkflowUnitPk As WorkflowUnitPk) As Integer
			Try
				Dim dt As DataTable = BRApi.Database.ExecuteSqlUsingReader(objDbConnInfoApp, Me.GetIntersectionValidationErrorsCountQuery(si, currentWorkflowUnitPk), False)
				If dt IsNot Nothing Then
					Return dt.Rows(0)(0)
				Else
					Return -1
				End If
				
			Catch ex As Exception
				brapi.ErrorLog.LogMessage(si, $"Exception getting intersection error count. {ex.Message}")
				Return -1
			End Try
		End Function
		Public Function GenerateIntersectionReport(ByVal si As SessionInfo, ByVal objDbConnInfoApp As DbConnInfoApp, ByVal currentWorkflowUnitPk As WorkflowUnitPk, ByVal fullFilePathName As String) As Boolean
			Try
				Dim fileCreated As Boolean
				
				Dim dt As DataTable = BRApi.Database.ExecuteSqlUsingReader(objDbConnInfoApp, Me.GetIntersectionValidationErrorsCountQuery(si, currentWorkflowUnitPk), False)
				If dt IsNot Nothing Then
					If dt.Rows(0)(0) < 150 Then
						If Me.WriteIntersectionErrorsToFile(si, objDbConnInfoApp, currentWorkflowUnitPk, fullFilePathName) Then
							fileCreated = True
						End If
					End If
				End If
				
				If fileCreated Then
					Return True
				Else
					Return False
				End If
				
			Catch ex As Exception
				brapi.ErrorLog.LogMessage(si, $"Exception generating intersection report. {ex.Message}")
				Return False
			End Try
		End Function
		Public Function WriteIntersectionErrorsToFile(ByVal si As SessionInfo, ByVal dbConn As DbConnInfo, ByVal wfPk As WorkflowUnitPk, ByVal fullFilePathName As String) As Boolean
			Try
				
				Dim dt As DataTable = BRApi.Database.ExecuteSqlUsingReader(dbConn, Me.GetIntersectionValidationErrorsQuery(si, wfPk), False)
				If dt IsNot Nothing Then
				
					Dim body As New StringBuilder
					body.AppendLine(StartHTMLTable)
					
					Dim rowHeaders As New List(Of String)
					For Each dc As DataColumn In dt.Columns
						rowHeaders.Add(dc.ColumnName)
					Next
					
					body.AppendLine(NewHTMLTableRowHeader(rowHeaders))
					Dim r As Integer = 0
					
					Dim rowValues As New List(Of String)
		            For Each dr As DataRow In dt.Rows
						For Each dc As DataColumn In dt.Columns
							If dc.ColumnName.XFContainsIgnoreCase("ValidationMessagesXml") Then
								If r = 0 Then
									r += 1
								End If
								
								rowValues.Add(Me.GetXMLErrorMessage(si, dr(dc.ColumnName)))
							Else
								rowValues.Add(dr(dc.ColumnName))
							End If
						Next
						body.AppendLine(NewHTMLTableRow((rowValues)))
						rowValues.Clear
		            Next
		    	    body.AppendLine(EndHTMLTable)
					
					Using fdxDataFile As System.IO.StreamWriter = New StreamWriter(fullFilePathName, True)
						fdxDataFile.Write(body)
						fdxDataFile.Close									
					End Using
					
					Return True
				End If
				
				Return False
			Catch ex As Exception
				brapi.ErrorLog.LogMessage(si, $"Exception writing intersection errors to file. {ex.Message}")
				Return False
			End Try
		End Function
		Public Function GetXMLErrorMessage(ByVal si As SessionInfo, ByVal xml As String) As String
			Try
				
				Dim retValue As New Text.StringBuilder
				
				Dim xmlDoc As New xmlDocument
				xmlDoc.LoadXml(xml)
				Dim root As XmlElement = xmlDoc.DocumentElement
				
				'always will have only one message
				For Each message As XmlElement In xmlDoc.DocumentElement.SelectNodes("/dataCellValidationMsgList/messages/*")
					Dim errorMsg As String = message("errorMsg").InnerXml
					Dim sParams As New List(Of String)
					For Each stringParams As XmlElement In message.GetElementsByTagName("stringParam")
						sParams.Add(stringParams.InnerText)
					Next
					If sParams.Count > 0 Then
						retValue.AppendLine(String.Format(errorMsg,sParams.ToArray))
					Else
						retValue.AppendLine(errorMsg)
					End If
				Next
				
				Return retValue.ToString
				
			Catch ex As Exception
				Return xml
			End Try
		End Function
		Public Function GetIntersectionValidationErrorsQuery(ByVal si As SessionInfo, ByVal currentWorkflowUnitPk As WorkflowUnitPk) As String
			Try
				Dim sql As New Text.StringBuilder
				
				sql.Append("Select ")
				'sql.Append("	WorkflowProfileHierarchy.HierarchyIndex, ")
				'sql.Append("	WorkflowProfileHierarchy.ProfileKey,")
				sql.Append("	WorkflowProfileHierarchy.ProfileName,")
				'sql.Append("	StageToFinanceValidationError.WorkflowProfileKey,")
				'sql.Append("	StageToFinanceValidationError.SummaryRowID, ")
'					sql.Append("	StageSummaryTargetData.SnT, ")
'					sql.Append("	StageSummaryTargetData.Cube, ")
'					sql.Append("	StageSummaryTargetData.TmT, ")
'					sql.Append("	StageSummaryTargetData.Am, ")
				sql.Append("	StageSummaryTargetData.EtT, ")
'					sql.Append("	StageSummaryTargetData.PrT, ")
'					sql.Append("	StageSummaryTargetData.CnT, ")
'					sql.Append("	StageSummaryTargetData.VwT, ")
				sql.Append("	StageSummaryTargetData.AcT, ")
'					sql.Append("	StageSummaryTargetData.FwT, ")
'					sql.Append("	StageSummaryTargetData.OgT, ")
				sql.Append("	StageSummaryTargetData.IcT, ")
				sql.Append("	StageSummaryTargetData.U1T, ")
				sql.Append("	StageSummaryTargetData.U2T, ")
				sql.Append("	StageSummaryTargetData.U3T, ")
				sql.Append("	StageSummaryTargetData.U4T, ")
				sql.Append("	StageSummaryTargetData.U5T, ")
				sql.Append("	StageSummaryTargetData.U6T, ")
				sql.Append("	StageSummaryTargetData.U7T, ")
				sql.Append("	StageSummaryTargetData.U8T, ")
				sql.Append("	StageToFinanceValidationError.ValidationMessagesXml ")
				
'					sql.Append("CAST(REPLACE(CAST(StageToFinanceValidationError.ValidationMessagesXml As NVARCHAR(MAX)),'utf-8','utf-16') AS XML).value('(dataCellValidationMsgList/messages/message/errorMsg)[1]', 'varchar(max)'),")
'					sql.Append("CAST(REPLACE(CAST(StageToFinanceValidationError.ValidationMessagesXml As NVARCHAR(MAX)),'utf-8','utf-16') AS XML).value('(dataCellValidationMsgList/messages/message/stringParams/stringParam)[1]', 'varchar(max)'),")
'					sql.Append("CAST(REPLACE(CAST(StageToFinanceValidationError.ValidationMessagesXml As NVARCHAR(MAX)),'utf-8','utf-16') AS XML).value('(dataCellValidationMsgList/messages/message/stringParams/stringParam)[2]', 'varchar(max)')")
				
				sql.Append("From")
				sql.Append("	StageToFinanceValidationError ")
				sql.Append("INNER Join WorkflowProfileHierarchy On StageToFinanceValidationError.WorkflowProfileKey = WorkflowProfileHierarchy.ProfileKey ")
				sql.Append("INNER Join StageSummaryTargetData On StageSummaryTargetData.SummaryRowID = StageToFinanceValidationError.SummaryRowID ")

				sql.Append("Where")
				sql.Append("	WorkflowProfileHierarchy.ProfileKey = '" & currentWorkflowUnitPk.ProfileKey.ToString & "' ")
				sql.Append("	And StageToFinanceValidationError.WorkflowScenarioKey = " & currentWorkflowUnitPk.ScenarioKey.ToString)
				sql.Append("	And StageToFinanceValidationError.WorkflowTimeKey = " & currentWorkflowUnitPk.TimeKey.ToString & " ")
				sql.Append("Order By")
				sql.Append("	WorkflowProfileHierarchy.HierarchyIndex,  ")
				sql.Append("	StageToFinanceValidationError.AccountId")
				
				Return sql.ToString
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		Public Function GetIntersectionValidationErrorsCountQuery(ByVal si As SessionInfo, ByVal currentWorkflowUnitPk As WorkflowUnitPk) As String
			Try
				Dim sql As New Text.StringBuilder
				
				sql.Append("Select Count (*) ")
				sql.Append("From")
				sql.Append("	StageToFinanceValidationError ")
				
				sql.Append("Where")
				sql.Append("	WorkflowProfileKey = '" & currentWorkflowUnitPk.ProfileKey.ToString & "' ")
				sql.Append("	And WorkflowScenarioKey = " & currentWorkflowUnitPk.ScenarioKey.ToString)
				sql.Append("	And WorkflowTimeKey = " & currentWorkflowUnitPk.TimeKey.ToString & " ")
				
				Return sql.ToString
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
        ''DPA-29476/vn50tv8/DEC 29th 2021- app2appNotification
		Public Sub GetApp2AppDetailsAndSendEmail(ByVal si As SessionInfo, ByVal statevalue As String, ByVal distributionList As List(Of String), ByVal subjectPreText As String, ByVal dictWorkflowInfo As  Dictionary(Of String, String), ByVal emailServer As String)
			Try				
					Dim subject As String = subjectPreText & $"- Batch Detail Report for DM Job"
					Dim eResult As New EmailResults
					Dim importStatus As String = "N/A"
					Dim transformationStatus As String = "N/A"
					Dim intersectionStatus As String = "N/A"
					Dim loadStatus As String = "N/A"
					Dim processCubeStatus As String = "N/A"
					Dim fullFilePathName As String = "N/A"	
					Dim workflowInfo As String = "N/A"
					Dim rowCount As String = String.Empty
					Dim wfName As String = String.Empty
					Dim wfScen As String = String.Empty
					Dim wfTime As String = String.Empty
					Dim targetApp As String = String.Empty
					Dim SourceApp As String = String.Empty
					Dim errorInfo As String = String.Empty
					Dim app2AppCopy As String = String.Empty
					Dim appNames As String = String.Empty
					Dim triggeredBy As String=String.Empty
					
					 ' Loop over pairs.
				        For Each wfInfo In dictWorkflowInfo
							Select wfInfo.Key.ToLower 
								Case "wfname"
									wfName = wfInfo.Value 
								Case "wftime"
									wfTime = wfInfo.Value
								Case "wfscen"
									wfScen = wfInfo.Value
								Case "targetapp"
									targetApp ="Target : " + wfInfo.Value
								Case "app2appcopy"
									app2AppCopy =  wfInfo.Value
								Case "appnames"
									appNames =  wfInfo.Value
								Case "rowcount"
									rowCount = wfInfo.Value
								Case "errorinfo"
									errorInfo = wfInfo.Value
							End Select							
				      Next
					
					Dim listMessages As String() = statevalue.Split(New String() {Environment.NewLine},
                                       StringSplitOptions.None)
					For i As Integer = 0 To listMessages.Length - 1
    						Dim message = listMessages(i).Replace(" ", "")	
							brapi.ErrorLog.LogMessage(si,message)
							 If(message.ToLower.Trim.Contains("dataloadtransform")) Then
								importStatus= IIf(message.ToLower.Trim.Contains("dataloadtransformcompleted"),"Completed with " & rowCount & " rows ","Import failed." & $"</br> {errorInfo}")
							 ElseIf(message.ToLower.Trim.Contains("validatetransform")) Then
								transformationStatus= IIf(message.ToLower.Trim.Contains("validatetransformcompleted"),"Completed","Validate Transform Failed" & Environment.NewLine & errorInfo)
							 ElseIf(message.ToLower.Trim.Contains("validateintersection")) Then
								intersectionStatus= IIf(message.ToLower.Trim.Contains("validateintersectioncompleted"),"Completed","Validate Intersection Failed" & Environment.NewLine & errorInfo)
							 ElseIf(message.ToLower.Trim.Contains("loadcube")) Then
								loadStatus= IIf(message.ToLower.Trim.Contains("loadcubecompleted"),"Completed","Loadcube Failed" & Environment.NewLine & errorInfo)
							 ElseIf(message.ToLower.Trim.Contains("processcube")) Then
								processCubeStatus= IIf(message.ToLower.Trim.Contains("processcubecompleted"),"Completed","Processcube Failed" & Environment.NewLine & errorInfo)
							 End If							
					
					 Next
				    Dim status As String = String .Empty 
					If (importStatus.ToLower().Contains("fail") Or (transformationStatus.ToLower().Contains("fail")) Or (intersectionStatus.ToLower().Contains("fail")) Or (loadStatus.ToLower().Contains("fail")) Or (processCubeStatus.ToLower().Contains("fail"))) Then
						status = "Fail"
						brapi.ErrorLog.LogMessage(si,"status" & status)
					ElseIf (importStatus.ToLower().Contains("completed") And (transformationStatus.ToLower().Contains("completed")) And (intersectionStatus.ToLower().Contains("completed")) And (loadStatus.ToLower().Contains("completed")) And (processCubeStatus.ToLower().Contains("completed"))) Then
						status = "Success"
						brapi.ErrorLog.LogMessage(si,"status" & status)
					Else 
						brapi.ErrorLog.LogMessage(si,"status" & status)
						Exit Sub
					End If
					
					Dim firstName As String = String.Empty 
					Dim lastName As String = String.Empty 
					GetUserDescription(si,firstName,lastName)
					eResult.Add(si, _
								$"{wfName}</br>{wfTime}</br>{wfScen}</br>{app2AppCopy}</br>{appNames}", _
									status, _
									importStatus, _
									transformationStatus, _
									intersectionStatus, _
									loadStatus, _
									processCubeStatus, _
									$"{firstName}</br>{lastName}")					
															
					Dim body As New StringBuilder
					Dim rowHeaders As New List(Of String)
					rowHeaders.Add("Workflow Info")
					rowHeaders.Add("Batch Status")
					rowHeaders.Add("Import Status")
					rowHeaders.Add("Transformation Status")
					rowHeaders.Add("Intersection Status")
					rowHeaders.Add("Load Cube Status")
					rowHeaders.Add("Process Cube Status")
					rowHeaders.Add("Triggered By")
				
					body.AppendLine(StartHTMLTable)
					body.AppendLine(NewHTMLTableRowHeader(rowHeaders))
					Dim r As Integer = 0
					Dim rowValues As New List(Of String)
		            For Each rslt As EmailResult In eResult.Results
						rowValues.Add(rslt.wfDetails)
						rowValues.Add(rslt.Status)
						rowValues.Add(rslt.ImportStatus)
						rowValues.Add(rslt.TransformationStatus)
						rowValues.Add(rslt.IntersectionStatus)
						rowValues.Add(rslt.LoadStatus)
						rowValues.Add(rslt.ProcessCubeStatus)
						rowValues.Add(rslt.TriggeredBy)
						body.AppendLine(NewHTMLTableRow((rowValues)))
						rowValues.Clear
		            Next
		    	    body.AppendLine(EndHTMLTable)
	            					
					BRApi.Utilities.SendMail(si, emailServer, distributionList, subject, body.ToString, True, nothing)
				
			Catch ex As Exception
				brapi.ErrorLog.LogMessage(si, ex.Message)
			
			End Try 
					
		End Sub
		#Region "HTML Helpers"
			Public Function GetErrorEmailBody(ByVal parentIntegrationName As String) As String
				Return $"<b>An Error has Occurred</b></br>{parentIntegrationName} has failed to run."
			End Function
			
	        ''' <summary>
	        ''' Return a formatted html row
	        ''' </summary>
	        ''' <param name="si"></param>
	        ''' <param name="rowValues"></param>
	        ''' <returns></returns>
	        Public Function NewHTMLTableRow(ByVal rowValues As List(Of String), Optional ByVal paddingPx As String = "10px", Optional ByVal colSpan As Integer = 0, Optional ByVal lastColRowSpan As Integer = 0) As String
	            Dim strBldr As New StringBuilder
	            strBldr.Append("<tr>")
	            Dim styl As String
	            Dim cnt As Short = 0
	            For Each val As String In rowValues
	                cnt += 1
	                If cnt = 1 Then
	                    styl = $" style='color:{_foreColor};background-color:{_backColor};padding: {paddingPx}; text-align:left; vertical-align:top'"
	                Else If val.StartsWith("Fail") Then
	                    styl = " style='background-color:#ffe6e6;padding: 10Px; text-align:left; vertical-align:top'"
	                Else If val.StartsWith("Warning") Then
	                    styl = " style='background-color:#ffffb3;padding: 10Px; text-align:left; vertical-align:top'"
	                Else If val.StartsWith("Success") Then
	                    styl = " style='background-color:#ccffcc;padding: 10Px; text-align:left; vertical-align:top'"                              
	                Else If colSpan > 0 Then
	                    styl = $" style='color:{_foreColor};background-color:{_backColor};padding: {paddingPx}; text-align:left; vertical-align:top'"
	                Else
	                    styl = $" style='padding: {paddingPx}; text-align:left; vertical-align:top'"
	                End If
	                val = val.Replace(",","</br>")
	                If colSpan > 0 Then
	                    strBldr.Append($"<td{styl} colspan='{colSpan}'>{val}</td>")
	                Else If lastColRowSpan > 0 And cnt = rowValues.Count Then
	                    strBldr.Append($"<td{styl} rowspan='{lastColRowSpan}'>{val}</td>")
	                Else     
	                    strBldr.Append($"<td{styl}>{val}</td>")
	                End If
	            Next
	            strBldr.AppendLine("</tr>")
	            Return strBldr.toString
	        End Function
	        
	        ''' <summary>
	        ''' Return a formatted table header row
	        ''' </summary>
	        ''' <param name="si"></param>
	        ''' <param name="headerValues"></param>
	        ''' <returns></returns>
	        Public Function NewHTMLTableRowHeader(ByVal headerValues As List(Of String), Optional ByVal colWidths As Integer() = Nothing) As String
	            Dim styl As String = $"style='color:{_foreColor};background-color:{_backColor};text-align:left;padding: 8px;'"
	            Dim strBldr As New StringBuilder
	            strBldr.Append("<tr>")
	            Dim i As Short = 0
	            For Each val As String In headerValues
	                If colWidths IsNot Nothing Then
	                    styl = $"style='width:{colWidths(i)}%; color:{_foreColor};background-color:{_backColor}; text-align:left; padding:8px;'"
	                End If
	                strBldr.Append($"<th {styl}>{val}</th>")
	                i += 1
	            Next
	            strBldr.AppendLine("</tr>")
	            Return strBldr.toString
	        End Function
	        
	        Public Function StartHTMLUnorderedList() As String
	            Return "<ul>"
	        End Function
	        
	        Public Function EndHTMLUnorderedList() As String
	            Return "</ul>"
	        End Function
	        
	        Public Function NewListItem(ByVal item As String) As String
	            Return $"<li>{item}</li>"
	        End Function
	        
	        Public Function StartHTMLTable() As String
	            'Return "<table border='1' style='border-collapse:collapse; width:100%; table-layout: fixed; word-wrap: break-word'>"
				Return "<table border='1' style='border-collapse:collapse; max-width:100%; word-wrap:break-word; white-space:nowrap;'>"
	        End Function
	        
	        Public Function EndHTMLTable() As String
	            Return "</table>"
	        End Function              
	        
	        Public Function NewHTMLParagraph(ByVal p As String) As String
	            Return $"<p>{p}</p>"
	        End Function
		
    	#End Region
		'vn50tv8/DPA-29476/Dec29th
		#Region "GetUserDescription"
		Public Sub GetUserDescription(ByVal si As SessionInfo,ByRef firstName As String,ByRef lastName As String) 
			Dim currentUserName As String = si.AuthToken.UserName
			Dim userInfo As UserInfo = BRApi.Security.Admin.GetUser(si, currentUserName)
			Dim description As String = userInfo.User.Description
			
			Try
	            firstName = Description.Split(" ")(0)
				lastName = Description.Split(" ")(1)
	        Catch ex As Exception
				firstName = "System"
				lastName = "User"
				brapi.ErrorLog.LogMessage(si,"ex - " & ex.Message)
	        End Try
		End Sub
		#End Region
    End Class
    
	#Region "Email Classes"
	    Public Class EmailResults
	        Public Property Results As List(Of EmailResult)
	        Public Sub Add(si As SessionInfo, 
							wfDetails As String, 
							status As String, 
							importStatus As String, 
							transformationStatus As String,
							intersectionStatus As String,
							loadStatus As String,
							processCubeStatus As String,
							triggeredBy As String)
	            Dim eResult As New EmailResult
	            eResult.wfDetails = wfDetails
	            eResult.Status = status
	            eResult.ImportStatus = importStatus
				eResult.TransformationStatus = transformationStatus
				eResult.IntersectionStatus = intersectionStatus
	            eResult.LoadStatus = loadStatus
				eResult.ProcessCubeStatus = processCubeStatus
				eResult.TriggeredBy = triggeredBy 'DPA-29476
	            If Results Is Nothing Then Results = New List(Of EmailResult)
	            Results.Add(eResult)
	        End Sub
	    End Class
	    
	    Public Class EmailResult
	        Public Property wfDetails As String
	        Public Property Status As String
	        Public Property ImportStatus As String
			Public Property TransformationStatus As String
			Public Property IntersectionStatus As String
	        Public Property LoadStatus As String
			Public Property ProcessCubeStatus As String
		    Public Property TriggeredBy As String
	    End Class
    #End Region
	
	
End Namespace
]]></sourceCode>
        </businessRule>
        <businessRule businessRuleType="Extender" name="FCP_Integration_Metadata_Refresh">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies>
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_GATEWAY" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_VARIABLES" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_Models" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_UTILITY" />
            </referencedAssemblies>
            <sourceCode><![CDATA[Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database
Imports System.Threading.Tasks
Imports System.Net
Imports System.Net.Http
Imports System.Timers
Imports System.Threading
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq
Imports System.Web.Script.Serialization
Imports Newtonsoft.Json.JsonPropertyAttribute
Imports System.Diagnostics
Imports System.Net.Mail

Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_GATEWAY
Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_VARIABLES
Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_UTILITY
Imports OneStream.BusinessRule.Extender.OS_Models


Namespace OneStream.BusinessRule.Extender.FCP_Integration_Metadata_Refresh	
	Public Class MainClass
		Private totalPages As Integer
		Private m_Total_Pages As Integer
		Private page_Row_Validator As Integer=1
		Private row_Count_Total As Integer=0
		Private row_Count_File As Integer=0
	    Private totalPageCount As Integer=1
		
		Private batchID As String 
		Private strbuHierarchy As New System.Text.StringBuilder
		Private strbuProperties As New System.Text.StringBuilder
		Private hierarchy_Data As String 
		Private Const m_moduleName As String = "DimensionData"
		Private dimesionsHierarchy As List(Of Object) = New List(Of Object)
		Private dimesionsProperty As List(Of Object) = New List(Of Object)
		Private m_PageSize As Integer = 50000
		Private Const edmcs_Property As String ="edmcs_property"
		Private Const edmcs_Hierarchy As String ="edmcs_hierarchy"
		Private Const property_TypeBatchID As String ="EDMCS_OS_METADATA"
		'Private Const hierarchy_TypeBatchID As String ="Edmcs_hierarchy"
		Private Const param_Selected As String = "param_app_list_selected"
		Private Const param_dim_Selected As String = "param_dim_list_selected"
		
'		Private clsJSONtoCSV As New clsJSONtoCSV()
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As ExtenderArgs) As Object
			Try	
				Brapi.Dashboards.Parameters.SetLiteralParameterValue(si,False,"param_app_last_run_by_user",si.UserName)
				Brapi.Dashboards.Parameters.SetLiteralParameterValue(si,False,"param_app_last_run_time",(DateTime.Now).AddHours(6).ToString)
				strbuHierarchy.AppendLine(String.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8}", "APPLICATION_NAME", "DIMENSION_TYPE", "DIMENSION_NAME", "CHILD", "PARENT","OS_NM","OS_PARENT","SORT_ORDER", "AGG_WGT"))						
				strbuProperties.AppendLine(String.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13}", "APPLICATION_NAME", "DIMENSION_TYPE", "DIMENSION_NAME", "MEMBER_NAME", "OS_NAME", "OS_DESCRIPTION", "DESCRIPTION","TXT1", "TXT2", "TXT3", "TXT4","TXT5","TXT6","TXT7","TXT8"))			
				Dim AppName = args.NameValuePairs.XFGetValue(param_Selected)
				Dim Export = args.NameValuePairs.XFGetValue("export") 
			    Dim DimName = args.NameValuePairs.XFGetValue(param_dim_Selected)
				BRApi.ErrorLog.LogMessage(si, $"Dimension name FCP is -{AppName}")

				 Dim fcpGateway = New IntegrationGateWay(Of FCPDimensionParams)(si, m_moduleName, OSModuleType.DIMENSION)			   
		 
	            Dim AppNames As String() = AppName.Split(New Char() {","c})	
				Dim DimNames As String() = DimName.Split(New Char() {","c})	
				For Each appName In AppNames					
					Dim newSeshInfo = BRApi.Security.Authorization.CreateSessionInfoForAnotherApp(si, appName.Trim, openAppResult.Success)
					
					For Each dimName In DimNames 'New String() {"Flow", "UD2", "UD3", "UD4", "UD5", "UD6", "UD7", "UD8"}
						
						Dim dimInfo As KeyValuePair(Of DimType, String) = Me.GetDimensionType(dimName)
						Dim dims As List(Of OneStream.Shared.Wcf.Dim)  = BRApi.Finance.Dim.GetDims(newSeshInfo, dimInfo.Key.Id)
					
						For Each dimEntry In dims						
							Dim mbrs As List(Of Member) = BRApi.Finance.Members.GetAllMembers(newSeshInfo, dimEntry.DimPk, True)
							For Each mbr In mbrs
								Dim prntMbrs = BRApi.Finance.Members.GetParents(newSeshInfo, dimEntry.DimPk, mbr.MemberId, True)
								For Each prntMbr In prntMbrs 
									Dim relInfo = BRApi.Finance.Members.GetRelationshipInfo(newSeshInfo, mbr.DimTypeId, mbr.Name, prntMbr.Name)'										
                                    dimesionsHierarchy.add(GetDimensionInfoHierarchy(newSeshInfo, dimEntry.Name, mbr, prntMbr, relInfo))									   
                                    dimesionsProperty.add(GetDimensionInfoProperties(newSeshInfo, dimEntry.Name, mbr, prntMbr, relInfo))						
								Next
							Next
						Next			
					Next				
				Next			
			totalPages  = Math.Ceiling(dimesionsHierarchy.Count/m_PageSize)	
			BRApi.ErrorLog.LogMessage(si, $"Count ={dimesionsHierarchy.Count} Page size ={m_PageSize}  Total Page = {totalPages}")
		
			If export ="true" Then 				
				Dim logFolderPath As String = BRApi.Utilities.GetFileShareFolder(si, FileShareFolderTypes.ApplicationIncoming, Nothing).Replace("\Incoming","")  & "\Groups\Everyone\Metadata_Archive\"
				'logFolderPath &= "wfName\"
				If Not Directory.Exists(logFolderPath) Then
					Directory.CreateDirectory(logFolderPath) 
				End If 
				Dim hierarchyHeaderString As String="APP_NM,CHILD,PARENT,OS_NM,OS_PARENT,DIMENSION,DIMENSION_TYPE,SORT_ORDER, AGG_WGT" 
				Dim destfilePathHierarchy As String = $"{logFolderPath}\{DateTime.Now.ToString("ddMMyyyyHHmmss")}_{AppName}_{DimName}_Hierarchy_{si.UserName}.csv"
				Dim destfilePathProperty As String = $"{logFolderPath}\{DateTime.Now.ToString("ddMMyyyyHHmmss")}_{AppName}_{DimName}_Property_{si.UserName}.csv"
				File.WriteAllText(destfilePathHierarchy, strbuHierarchy.ToString()) 
				File.WriteAllText(destfilePathProperty, strbuProperties.ToString()) 
				BRApi.ErrorLog.LogMessage(si, $"File Export completed")
              Return Nothing
             End If 
			batchID = GetBatchIDFromFCP(si, fcpGateway,property_TypeBatchID)
 		    ProcessByPage(si, dimesionsProperty,edmcs_Property,batchID,fcpGateway,Export)
			ProcessByPage(si, dimesionsHierarchy,edmcs_Hierarchy,batchID,fcpGateway,Export)			
		    TriggerSendToFCP(si,fcpGateway)	 
			Return Nothing	
			
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
		Private Sub ProcessByPage(si As SessionInfo, data As List(Of Object), typeName As String, batchGuid As String,fcpGateway As Object,export As String)
			
			Try		
			
			   For pageNo As Integer = 0 To totalPages-1
				Dim sentData = data.Skip(pageNo * m_PageSize).Take(m_PageSize)
				Dim jsonPayload =	"{""Batch_ID"" :""" & batchGuid & """, ""Status"" :""Success"", ""Dataset_Type"" :""EDMCS_OS_METADATA"",""page"" :" + (pageNo+1).ToString +", ""total_pages"" :"+totalPages.ToString +",""" +typeName+""" : { ""rowcount"" :"+ sentData.ToList.Count.ToString+", ""data"" : " + JsonConvert.SerializeObject(sentData) + "}}"		       
			BRApi.ErrorLog.LogMessage(si, "hi")
			BRApi.ErrorLog.LogMessage(si, export)


			    Dim response = fcpGateway.PutData(si, jsonPayload,False,OSActionType.Put,1)
			    BRApi.ErrorLog.LogMessage(si, response.result.JsonData)
				If Not response.Result.Success Then
				Dim subject As String = $"Refresh Metadata to FCP failed  "
				CommonUtility.sendmail(si, "GetBatchIDFromFCP", "jsonPayLoad", m_moduleName & " - GetBatchIDFromFCP", fcpGateway.Params)
			Else 
				If fcpGateway.Params.Debugger Then
				BRApi.ErrorLog.LogMessage(si, $"{m_moduleName} - Refresh Metadata to FCP  successfully")
				End If
			End If
			
			Next
			
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
			
		End Sub
		
		Private Function GetBatchIDFromFCP(si As SessionInfo, fcpGateway As Object,type As String ) As String
			Dim payload As New Object()
						payload = New With {
						.Type =type
						}				
            
						
			Dim jsonPayLoad As String = JsonConvert.SerializeObject(payload)
			BRApi.ErrorLog.LogMessage(si, jsonPayLoad)
			Dim response = fcpGateway.PutData(si, jsonPayLoad,False,OSActionType.Guid)
			Dim jsonResult = JsonConvert.DeserializeObject(Of Dictionary(Of String, Object))(response.result.JsonData)
			BRApi.ErrorLog.LogMessage(si, jsonResult("BatchId").Tostring())
             Return jsonResult("BatchId").Tostring()
'							
			If Not response.Result.Success Then
				Dim subject As String = $"DimensionData post failed for "
				CommonUtility.sendmail(si, "HI", jsonPayLoad, m_moduleName & " - GetBatchIDFromFCP", fcpGateway.Params)
			Else
				If fcpGateway.Params.Debugger Then
					BRApi.ErrorLog.LogMessage(si, $"{m_moduleName} - DimensionData Fetched GUID successfully")
				End If
			End If
		End Function
		
		Private Sub TriggerSendToFCP(si As SessionInfo,fcpGateway As Object)
				Dim jsonTriggerProperty =	"{""Batch_ID"" :""" & batchID & """, ""Type"" :"""+ property_TypeBatchID+"""}"			
				Dim responseTriggerProperty = fcpGateway.PutData(si, jsonTriggerProperty, False, OSActionType.Trigger,2)				
				BRApi.ErrorLog.LogMessage(si, responseTriggerProperty.result.JsonData)
		End Sub
		
			Private Function GetDimensionInfoHierarchy(si As SessionInfo, dimName As String, mbr As Member, prntMbr As Member, relInfo As RelationshipInfo) As  Object
                Dim resultHierarchy As Object() = New Object(1) {}		   
 			    row_Count_Total= row_Count_Total+1
				row_Count_File=row_Count_File+1
				Dim mbrInfo = BRApi.Finance.Members.GetMemberInfo(si, mbr.DimTypeId, mbr.MemberId, True)
				Dim sortOrder = If(relInfo Is Nothing, 0, relInfo.Relationship.SiblingSortOrder)
				Dim aggWeight = If(relInfo Is Nothing, 0, relInfo.Relationship.UDAggWeight)
				resultHierarchy(0) = New With { 
										.APP_NM = si.AppName, 
										.DIMENSION_TYPE = mbr.DimType.Name, 
										.MBR_DIMENSION = dimName, 
										.CHILD = Mbr.Name, 
										.PARENT = prntMbr.Name, 
										.OS_NM = mbr.Name, 
										.OS_Parent = prntMbr.Name, 
										.SORT_ORDER = sortorder, 
										.AGG_WGT = aggWeight 
									 }
			
   			strbuHierarchy.AppendLine(String.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8}", si.AppName, mbr.DimType.Name, dimName, Mbr.Name, prntMbr.Name, mbr.Name,prntMbr.Name,sortorder,aggWeight))
               
			
			Return resultHierarchy(0)
	
		End Function
		
		Private Function GetDimensionInfoProperties(si As SessionInfo, dimName As String, mbr As Member, prntMbr As Member, relInfo As RelationshipInfo) As Object
 			Try
				Dim mbrInfo = BRApi.Finance.Members.GetMemberInfo(si, mbr.DimTypeId, mbr.MemberId, True)
				Dim sortOrder = If(relInfo Is Nothing, 0, relInfo.Relationship.SiblingSortOrder)
				Dim aggWeight = If(relInfo Is Nothing, 0, relInfo.Relationship.UDAggWeight)
				  Dim result_Property As Object() = New Object(1) {}			
				Select mbr.DimType.Name
					Case "Entity"
					    Dim p = mbrInfo.GetEntityProperties()
						result_Property(0) =  New With { 
												 .APP_NM = si.AppName, 
												 .DIMENSION_TYPE = mbr.DimType.Name, 
												 .MBR_DIMENSION = dimName, 
												 .DIMENSION_NM = mbr.Name,												 
												 .OS_NM = mbr.Name,
												 .RDATAGROUP = mbr.ReadDataGroupUniqueID,
												 .RDATAGROUP1 = mbr.ReadDataGroupUniqueID2,	
												 .RWDATAGROUP = mbr.ReadDataGroupUniqueID,
												 .RWDATAGROUP1 = mbr.ReadWriteDataGroupUniqueID2,
												 .CUBEDATAACCESS =mbr.DataCellAccessCategories,
												 .CURRENCY =p.Currency,
												 .ISIC = p.IsIC,
												 .ISCONSOLIDATED =p.IsConsolidated,
												 .ISCONSTRAINT = p.ICConstraint,
												 .INUSE =p.InUse,
												 .ALLOWADJ = p.AllowAdjustments,
												 .ALLOWAJDFROMCHILD =p.AllowAdjustmentsFromChildren,
												 .UD1 =p.UD1Constraint,
												 .UD2 = p.UD2Constraint,
												 .UD3=p.UD3Constraint,
												 .UD4=p.UD4Constraint,
												 .UD5 = p.UD5Constraint,
												 .UD6=p.UD6Constraint,
												 .UD7=p.UD7Constraint,
												 .UD8 = p.UD8Constraint,
												 .DIMENSION_DESC = mbr.Description, 
												 .TXT1 = p.Text1.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT2 = p.Text2.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT3 = p.Text3.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT4 = p.Text4.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT5 = p.Text5.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT6 = p.Text6.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT7 = p.Text7.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT8 = p.Text8.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId)												
											 }
					Case "Scenario"
						Dim p = mbrInfo.GetScenarioProperties()
						result_Property(0) =  New With { 
												 .APP_NM = si.AppName, 
												 .DIMENSION_TYPE = mbr.DimType.Name, 
												 .MBR_DIMENSION = dimName, 
												 .DIMENSION_NM = mbr.Name, 
												 .OS_NM = mbr.Name, 
												 .DIMENSION_DESC = mbr.Description, 
												 .TXT1 = p.Text1.GetStoredValue(), 
												 .TXT2 = p.Text2.GetStoredValue(), 
												 .TXT3 = p.Text3.GetStoredValue(), 
												 .TXT4 = p.Text4.GetStoredValue(), 
												 .TXT5 = p.Text5.GetStoredValue(), 
												 .TXT6 = p.Text6.GetStoredValue(), 
												 .TXT7 = p.Text7.GetStoredValue(), 
												 .TXT8 = p.Text8.GetStoredValue()
											 }
					Case "Account"
						Dim p = mbrInfo.GetAccountProperties()
						result_Property(0) =  New With { 
												 .APP_NM = si.AppName, 
												 .DIMENSION_TYPE = mbr.DimType.Name, 
												 .MBR_DIMENSION = dimName, 
												 .DIMENSION_NM = mbr.Name, 
												 .OS_NM = mbr.Name, 
												 .DIMENSION_DESC = mbr.Description, 
												 .TXT1 = p.Text1.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT2 = p.Text2.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT3 = p.Text3.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT4 = p.Text4.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT5 = p.Text5.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT6 = p.Text6.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT7 = p.Text7.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT8 = p.Text8.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId)
											 }
					Case "Flow"
						Dim p = mbrInfo.GetFlowProperties()
						result_Property(0) =  New With { 
												 .APP_NM = si.AppName, 
												 .DIMENSION_TYPE = mbr.DimType.Name, 
												 .MBR_DIMENSION = dimName, 
												 .DIMENSION_NM = mbr.Name, 
												 .OS_NM = mbr.Name, 
												 .DIMENSION_DESC = mbr.Description, 
												 .TXT1 = p.Text1.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT2 = p.Text2.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT3 = p.Text3.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT4 = p.Text4.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT5 = p.Text5.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT6 = p.Text6.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT7 = p.Text7.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT8 = p.Text8.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId)
											 }
					Case Else 'UD1, UD2, UD3, UD4, UD5,  UD6, UD7, UD8
						 Dim p = mbrInfo.GetUDProperties()
						 result_Property(0) =  New With { 
												 .APP_NM = si.AppName, 
												 .DIMENSION_TYPE = mbr.DimType.Name, 
												 .MBR_DIMENSION = dimName, 
												 .DIMENSION_NM = mbr.Name, 
												 .OS_NM = mbr.Name, 
												 .DIMENSION_DESC = mbr.Description, 
												 .TXT1 = p.Text1.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT2 = p.Text2.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT3 = p.Text3.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT4 = p.Text4.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT5 = p.Text5.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT6 = p.Text6.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT7 = p.Text7.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId), 
												 .TXT8 = p.Text8.GetStoredValue(DimType.Scenario.DefaultMemberId, DimType.Time.DefaultMemberId)
											 }
				End Select
				If Not (mbr.DimType.Name="Entity")					
				strbuProperties.AppendLine(String.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13}", si.AppName, mbr.DimType.Name, dimName, Mbr.Name, Mbr.Name, mbr.Name, Mbr.Description, result_Property(0).TXT1, result_Property(0).TXT2, result_Property(0).TXT3, result_Property(0).TXT4, result_Property(0).TXT5, result_Property(0).TXT6, result_Property(0).TXT7, result_Property(0).TXT8))
			Else
				strbuProperties.AppendLine(String.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13},{14},{15},{16},{17},{18},{19},{20},{21},{22},{23},{24},{25},{26},{27},{28},{29},{30},{31},{32},{33}", si.AppName, mbr.DimType.Name, dimName, Mbr.Name, Mbr.Name, mbr.Name, Mbr.Description, result_Property(0).TXT1, result_Property(0).TXT2, result_Property(0).TXT3, result_Property(0).TXT4, result_Property(0).TXT5, result_Property(0).TXT6, result_Property(0).TXT7, result_Property(0).TXT8,result_Property(0).RDATAGROUP,result_Property(0).RDATAGROUP1,result_Property(0).RWDATAGROUP, result_Property(0).RWDATAGROUP1, result_Property(0).CUBEDATAACCESS,result_Property(0).CURRENCY, result_Property(0).ISIC, result_Property(0).ISCONSOLIDATED,result_Property(0).ISCONSTRAINT, result_Property(0).INUSE, result_Property(0).ALLOWADJ, result_Property(0).ALLOWAJDFROMCHILD,result_Property(0).UD1,result_Property(0).UD2, result_Property(0).UD3,result_Property(0).UD4, result_Property(0).UD5,result_Property(0).UD6,result_Property(0).UD7,result_Property(0).UD8 ))
			     End If
'				Return (JsonConvert.SerializeObject(result_Property(0)) + ",")
                Return (result_Property(0))
			Catch ex As Exception				
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try	
			
		End Function
		
		Private Function GetDimensionType(dimTypeName As String) As KeyValuePair(Of DimType, String)
			Select dimTypeName
				Case "Entity"
					Return New KeyValuePair(Of DimType, String)(DimType.Entity, "E#")
				Case "Scenario"
					Return New KeyValuePair(Of DimType, String)(DimType.Scenario, "S#")
				Case "Account"
					Return New KeyValuePair(Of DimType, String)(DimType.Account, "A#")
				Case "Flow"
					Return New KeyValuePair(Of DimType, String)(DimType.Flow, "F#")
				Case "UD1"
					Return New KeyValuePair(Of DimType, String)(DimType.UD1, "U1#")
				Case "UD2"
					Return New KeyValuePair(Of DimType, String)(DimType.UD2, "U2#")
				Case "UD3"
					Return New KeyValuePair(Of DimType, String)(DimType.UD3, "U3#")
				Case "UD4"
					Return New KeyValuePair(Of DimType, String)(DimType.UD4, "U4#")
				Case "UD5"
					Return New KeyValuePair(Of DimType, String)(DimType.UD5, "U5#")
				Case "UD6"
					Return New KeyValuePair(Of DimType, String)(DimType.UD6, "U6#")
				Case "UD7"
					Return New KeyValuePair(Of DimType, String)(DimType.UD7, "U7#")
				Case Else
					Return New KeyValuePair(Of DimType, String)(DimType.UD8, "U8#")
			End Select
		End Function
		

	End Class
	
	
	#Region "Dimension"
	
	Public Class Dimension
		
		Private m_dimType As String
		Public Property DimType() As String
			Get
				Return m_dimType
			End Get
			Set
				m_dimType = value
			End Set
		End Property
		
		Private m_dimName As String
		Public Property DimName() As String
			Get
				Return m_dimName
			End Get
			Set
				m_dimName = value
			End Set
		End Property
		
		Private m_memberName As String
		Public Property MemberName() As String
			Get
				Return m_memberName
			End Get
			Set
				m_memberName = value
			End Set
		End Property
		
		Private m_memberDesc As String
		Public Property MemberDesc() As String
			Get
				Return m_memberDesc
			End Get
			Set
				m_memberDesc = value
			End Set
		End Property
		
		Private m_rdatagroup1 As String
		Public Property RDataGroup1() As String
			Get
				Return m_rdatagroup1
			End Get
			Set
				m_rdatagroup1 = value
			End Set
		End Property
		
		Private m_rdatagroup2 As String
		Public Property rDataGroup2() As String
			Get
				Return m_rdatagroup2
			End Get
			Set
				m_rdatagroup2 = value
			End Set
		End Property
		Private m_rwdatagroup1 As String
		Public Property RWDataGroup1() As String
			Get
				Return m_rwdatagroup1
			End Get
			Set
				m_rwdatagroup1 = value
			End Set
		End Property
		
		Private m_rwdatagroup2 As String
		Public Property rwDataGroup2() As String
			Get
				Return m_rwdatagroup2
			End Get
			Set
				m_rwdatagroup2 = value
			End Set
		End Property
		
		Private m_dataaccessSecurity As String
		Public Property rwdasecurity() As String
			Get
				Return m_dataaccessSecurity
			End Get
			Set
				m_dataaccessSecurity = value
			End Set
		End Property
		
		Private m_currency As String
		Public Property currency() As String
			Get
				Return m_currency
			End Get
			Set
				m_currency = value
			End Set
		End Property
		
		
		Private m_isconsolidated As String
		Public Property IsConsolidated() As String
			Get
				Return m_isconsolidated
			End Get
			Set
				m_isconsolidated = value
			End Set
		End Property
		
		Private m_inuse As String
		Public Property inuse() As String
			Get
				Return m_inuse
			End Get
			Set
				m_inuse = value
			End Set
		End Property
		
		Private m_allwoAdjustment As String
		Public Property allowadjustment() As String
			Get
				Return m_allwoAdjustment
			End Get
			Set
				m_allwoAdjustment = value
			End Set
		End Property
		
		
		Private m_allwoAdjustmentfromchilderen As String
		Public Property allowadjustmentfromchildern() As String
			Get
				Return m_allwoAdjustmentfromchilderen
			End Get
			Set
				m_allwoAdjustmentfromchilderen = value
			End Set
		End Property
		
		Private m_UD1 As String
		Public Property UD1() As String
			Get
				Return m_UD1
			End Get
			Set
				m_UD1 = value
			End Set
		End Property
		
		Private m_UD2 As String
		Public Property UD2() As String
			Get
				Return m_UD2
			End Get
			Set
				m_UD2 = value
			End Set
		End Property
		Private m_UD4 As String
		Public Property UD4() As String
			Get
				Return m_UD4
			End Get
			Set
				m_UD4 = value
			End Set
		End Property
		Private m_UD3 As String
		Public Property UD3() As String
			Get
				Return m_UD3
			End Get
			Set
				m_UD3 = value
			End Set
		End Property
		Private m_UD5 As String
		Public Property UD5() As String
			Get
				Return m_UD5
			End Get
			Set
				m_UD5 = value
			End Set
		End Property
		Private m_UD6 As String
		Public Property UD6() As String
			Get
				Return m_UD6
			End Get
			Set
				m_UD6 = value
			End Set
		End Property
		Private m_UD7 As String
		Public Property UD7() As String
			Get
				Return m_UD7
			End Get
			Set
				m_UD7 = value
			End Set
		End Property
		Private m_UD8 As String
		Public Property UD8() As String
			Get
				Return m_UD8
			End Get
			Set
				m_UD8 = value
			End Set
		End Property
		
		Private m_isIC	 As String
		Public Property IsIc() As String
			Get
				Return m_isIC
			End Get
			Set
				m_isIC = value
			End Set
		End Property
		
		Private m_parentMember As String
		Public Property ParentMember() As String
			Get
				Return m_parentMember
			End Get
			Set
				m_parentMember = value
			End Set
		End Property
		
		Private m_text1 As String
		Public Property Text1() As String
			Get
				Return m_text1
			End Get
			Set
				m_text1 = value
			End Set
		End Property
		
		Private m_text2 As String
		Public Property Text2() As String
			Get
				Return m_text2
			End Get
			Set
				m_text2 = value
			End Set
		End Property
		
		Private m_text3 As String
		Public Property Text3() As String
			Get
				Return m_text3
			End Get
			Set
				m_text3 = value
			End Set
		End Property
		
		Private m_text4 As String
		Public Property Text4() As String
			Get
				Return m_text4
			End Get
			Set
				m_text4 = value
			End Set
		End Property
		
		Private m_text5 As String
		Public Property Text5() As String
			Get
				Return m_text5
			End Get
			Set
				m_text5 = value
			End Set
		End Property
		
		Private m_text6 As String
		Public Property Text6() As String
			Get
				Return m_text6
			End Get
			Set
				m_text6 = value
			End Set
		End Property
		
		Private m_text7 As String
		Public Property Text7() As String
			Get
				Return m_text7
			End Get
			Set
				m_text7 = value
			End Set
		End Property
		
		Private m_text8 As String
		Public Property Text8() As String
			Get
				Return m_text8
			End Get
			Set
				m_text8 = value
			End Set
		End Property
		
'		Public Sub New(dimType As String, dimName As String, memberName As String, memberDesc As String, parentMember As String, text1 As String, text2 As String, text3 As String, text4 As String, text5 As String, text6 As String, text7 As String, text8 As String)
'			Me.DimType = dimType
'			Me.DimName = dimName
'			Me.MemberName = memberName
'			Me.MemberDesc = memberDesc
'			Me.ParentMember = parentMember
'			Me.Text1 = text1
'			Me.Text2 = text2
'			Me.Text3 = text3
'			Me.Text4 = text4
'			Me.Text5 = text5
'			Me.Text6 = text6
'			Me.Text7 = text7
'			Me.Text8 = text8
'		End Sub

	End Class
	
	#End Region
	 	
End Namespace
	]]></sourceCode>
        </businessRule>
        <businessRule businessRuleType="Extender" name="OS_INTEGRATION_GATEWAY">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies>
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_VARIABLES" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_Models" />
            </referencedAssemblies>
            <sourceCode><![CDATA[Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports System.Security.Cryptography
Imports System.Text
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database

Imports System.Net
Imports System.Net.Http
Imports System.Threading.Tasks
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq
'Test Rajesh 

Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_VARIABLES
Imports OneStream.BusinessRule.Extender.OS_Models

Namespace OneStream.BusinessRule.Extender.OS_INTEGRATION_GATEWAY
	Public Class IntegrationGateway(Of T As IntegrationParams)
		Implements IDisposable
		
	 	Private Const ENCRIPTION_KEY As String = "Man0maN"
		Private _integrationParams As T
		Private _paramProvider As IParamProvider
		Private _paramProviderFactory = New IntegrationParamProviderFactory()
		Private _moduleName As String
		Private m_Client As HttpClient
		
		
		Const defaultTimeout As Int16 = 30
		Const defaultMSVersion As String = "2018-03-28"
		Const defaultCacheControl As String = "no-cache"
		
		Public ReadOnly Property Params() As T
			Get
				Return _integrationParams
			End Get
		End Property
		
		Public Sub New(ByVal si As SessionInfo)
		End Sub	
		
		Public Sub New(ByVal si As SessionInfo, ByVal moduleName As String, ByVal moduleType As OSModuleType, Optional ByVal args As ExtenderArgs = Nothing)
			
			_paramProvider = _paramProviderFactory.GetProvider(si, moduleName, moduleType, args)
			_integrationParams = _paramProvider.Params
			_moduleName = moduleName
			
			m_Client = New HttpClient()
			
			m_Client.Timeout = TimeSpan.FromMinutes(defaultTimeout)
			m_Client.DefaultRequestHeaders.Clear()
			m_Client.DefaultRequestHeaders.ConnectionClose = False
			m_Client.DefaultRequestHeaders.Add("cache-control", defaultCacheControl)
			
			If IntegrationParamProviderFactory.FCPModules.Contains(moduleType) Then
				Dim fcpParams = DirectCast(DirectCast(_integrationParams, Object), FCPIntegrationParams)
				m_Client.DefaultRequestHeaders.Add("WM_CONSUMER.ID", Me.Decrypt(fcpParams.ConsumerId, ENCRIPTION_KEY))
				m_Client.DefaultRequestHeaders.Add("WM_SVC.ENV", fcpParams.SvcEnv)
				m_Client.DefaultRequestHeaders.Add("WM_SVC.NAME", fcpParams.SvcName)
				m_Client.DefaultRequestHeaders.Add("x-ms-version", defaultMSVersion)
			End If
						
		End Sub	
		
		Public Async Function GetData(ByVal si As SessionInfo, ByVal params As Dictionary(Of String, String), Optional ByVal isData As Boolean = True, Optional ByVal action As OSActionType = OSActionType.Get) As Task(Of OSJsonResponse)
			Dim result As OSJsonResponse = New OSJsonResponse()
			Dim endPoint As String = String.Empty
			Try
				endPoint = $"{_integrationParams.EndPoint(action.ToString)(0)}/{IF(isData, "getData", "getMeta")}/{_moduleName}"
				
				If(params.Count > 0)
					endPoint = $"{endPoint}?" & String.Join("&", params.Select(Function(kv) $"{kv.Key}={kv.Value}"))
				End If
				'BRApi.ErrorLog.LogMessage(si, endPoint)
				Dim response As HttpResponseMessage = Await m_Client.GetAsync(New Uri(endPoint))
				
				result.Success = response.IsSuccessStatusCode
				result.StatusCode = response.StatusCode
				result.ReasonPhrase = response.ReasonPhrase				
				result.JsonData = response.Content.ReadAsStringAsync().Result
				
			Catch ex As HttpRequestException
				result.Success = False
				result.JsonData = "{}"
				If ex.InnerException IsNot Nothing And ex.InnerException.GetType Is GetType(WebException) Then
					Dim wex = DirectCast(ex.InnerException, WebException)
					result.StatusCode = wex.Status
					result.ReasonPhrase = $"{wex.Message}, {endPoint}"
				Else
					result.StatusCode = "000"
					result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				End If
			Catch ex As Exception	
				result.Success = False
				result.StatusCode = "000"
				result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				result.JsonData = "{}"
			Finally
				result.Url = endPoint
			End Try
			'BRApi.ErrorLog.LogMessage(si, $"{JsonConvert.SerializeObject(result)}")
			'BRApi.ErrorLog.LogMessage(si, $"Rajesh Mirsala Test ")
			Return result
		End Function
		
		Public Async Function PutData(ByVal si As SessionInfo, ByVal jsonData As String, ByVal isSuccessTrigger As Boolean, Optional ByVal action As OSActionType = OSActionType.Put, Optional ByVal seqNum As Integer = 0) As Task (Of OSJsonResponse)
			Dim result As OSJsonResponse = New OSJsonResponse()
			Dim endPoint As String = String.Empty
				
			Try		
				endPoint = _integrationParams.EndPoint(action.ToString)(seqNum)
				If isSuccessTrigger Then
					If endPoint.Contains("/loadDataPivot") Then
						endPoint = endPoint.Replace("/loadDataPivot", "/loadDataTrigger")
					Else If endPoint.Contains("/loadDataRpt") Then
						endPoint = endPoint.Replace("/loadDataRpt", "/loadDataTriggerRpt")
					Else If endPoint.Contains("/loadData") Then
						endPoint = endPoint.Replace("/loadData", "/loadDataTrigger")
					End If
				End If
				
				Dim content = New Http.StringContent(jsonData, System.Text.Encoding.UTF8, "application/json")
				Dim response As HttpResponseMessage = Await m_Client.PostAsync(endPoint, content, New System.Threading.CancellationToken(False))
				
				result.Success = response.IsSuccessStatusCode
				result.StatusCode = response.StatusCode
				result.ReasonPhrase = response.ReasonPhrase				
				result.JsonData = response.Content.ReadAsStringAsync().Result
			Catch ex As HttpRequestException
				result.Success = False
				result.JsonData = "{}"
				If ex.InnerException IsNot Nothing And ex.InnerException.GetType Is GetType(WebException) Then
					Dim wex = DirectCast(ex.InnerException, WebException)
					result.StatusCode = wex.Status
					result.ReasonPhrase = $"{wex.Message}, {endPoint}"
				Else
					result.StatusCode = "000"
					result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				End If
			Catch ex As Exception
				result.Success = False
				result.StatusCode = "000"
				result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				result.JsonData = "{}"
			Finally
				result.Url = endPoint
				'BRApi.ErrorLog.LogMessage(si, $"{JsonConvert.SerializeObject(result)}")
			End Try
			
			Return result		
		End Function
		
		Public Async Function PutData(ByVal si As SessionInfo, ByVal jsonData As String, Optional ByVal action As OSActionType = OSActionType.Put, Optional ByVal seqNum As Integer = 0) As Task (Of OSJsonResponse)
			Dim result As OSJsonResponse = New OSJsonResponse()
			Dim endPoint As String = String.Empty
				
			Try		
				endPoint = _integrationParams.EndPoint(action.ToString)(seqNum)
				'brapi.ErrorLog.LogMessage(si,$"endPoint : {endPoint}")

				Dim content = New Http.StringContent(jsonData, System.Text.Encoding.UTF8, "application/json")
				Dim response As HttpResponseMessage = Await m_Client.PutAsync(endPoint, content, New System.Threading.CancellationToken(False))
				
				result.Success = response.IsSuccessStatusCode
				result.StatusCode = response.StatusCode
				result.ReasonPhrase = response.ReasonPhrase				
				result.JsonData = response.Content.ReadAsStringAsync().Result
			Catch ex As HttpRequestException
				result.Success = False
				result.JsonData = "{}"
				If ex.InnerException IsNot Nothing And ex.InnerException.GetType Is GetType(WebException) Then
					Dim wex = DirectCast(ex.InnerException, WebException)
					result.StatusCode = wex.Status
					result.ReasonPhrase = $"{wex.Message}, {endPoint}"
				Else
					result.StatusCode = "000"
					result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				End If
			Catch ex As Exception
				result.Success = False
				result.StatusCode = "000"
				result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				result.JsonData = "{}"
			Finally
				result.Url = endPoint
				BRApi.ErrorLog.LogMessage(si, $"{JsonConvert.SerializeObject(result)}")
			End Try
			
			Return result		
		End Function
		Public Async Function GetBatchStatus(ByVal si As SessionInfo, ByVal batchId As String) As Task(Of OSJsonResponse)
			Dim result As OSJsonResponse = New OSJsonResponse()
			Dim endPoint As String = String.Empty
			Try
				endPoint = $"{_integrationParams.EndPoint(OSActionType.Status.ToString)(0)}{batchId}"
				
				'BRApi.ErrorLog.LogMessage(si, endPoint)
				Dim response As HttpResponseMessage = Await m_Client.GetAsync(New Uri(endPoint))
				
				result.Success = response.IsSuccessStatusCode
				result.StatusCode = response.StatusCode
				result.ReasonPhrase = response.ReasonPhrase				
				result.JsonData = response.Content.ReadAsStringAsync().Result
				
			Catch ex As HttpRequestException
				result.Success = False
				result.JsonData = "{}"
				If ex.InnerException IsNot Nothing And ex.InnerException.GetType Is GetType(WebException) Then
					Dim wex = DirectCast(ex.InnerException, WebException)
					result.StatusCode = wex.Status
					result.ReasonPhrase = $"{wex.Message}, {endPoint}"
				Else
					result.StatusCode = "000"
					result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				End If
			Catch ex As Exception	
				result.Success = False
				result.StatusCode = "000"
				result.ReasonPhrase = $"{ex.Message}, {endPoint}"
				result.JsonData = "{}"
			Finally
				result.Url = endPoint
			End Try
			'BRApi.ErrorLog.LogMessage(si, $"{JsonConvert.SerializeObject(result)}")
			Return result
		End Function
		
		Public Function Encrypt(clearText As String, encriptionKey As String) As String
		    Dim clearBytes As Byte() = Encoding.Unicode.GetBytes(clearText)
		    Using encryptor As Aes = Aes.Create()
		        Dim pdb As New Rfc2898DeriveBytes(encriptionKey, New Byte() {&H49, &H76, &H61, &H6E, &H20, &H4D, _
		         &H65, &H64, &H76, &H65, &H64, &H65, &H76})
		        encryptor.Key = pdb.GetBytes(32)
		        encryptor.IV = pdb.GetBytes(16)
		        Using ms As New MemoryStream()
		            Using cs As New CryptoStream(ms, encryptor.CreateEncryptor(), CryptoStreamMode.Write)
		                cs.Write(clearBytes, 0, clearBytes.Length)
		                cs.Close()
		            End Using
		            clearText = Convert.ToBase64String(ms.ToArray())
		        End Using
		    End Using
		    Return clearText
		End Function
	
		Public Function Decrypt(cipherText As String, encriptionKey As String) As String
			Dim cipherBytes As Byte() = Convert.FromBase64String(cipherText)
		    Using encryptor As Aes = Aes.Create()
		        Dim pdb As New Rfc2898DeriveBytes(encriptionKey, New Byte() {&H49, &H76, &H61, &H6E, &H20, &H4D, _
		         &H65, &H64, &H76, &H65, &H64, &H65, _
		         &H76})
		        encryptor.Key = pdb.GetBytes(32)
		        encryptor.IV = pdb.GetBytes(16)
		        Using ms As New MemoryStream()
		            Using cs As New CryptoStream(ms, encryptor.CreateDecryptor(), CryptoStreamMode.Write)
		                cs.Write(cipherBytes, 0, cipherBytes.Length)
		                cs.Close()
		            End Using
		            cipherText = Encoding.Unicode.GetString(ms.ToArray())
		        End Using
		    End Using
	    	Return cipherText
		End Function
		
		Public Sub Dispose() Implements IDisposable.Dispose
			If(m_Client IsNot Nothing) Then
				m_Client.Dispose
			End If
		End Sub
	
	End Class
End Namespace
]]></sourceCode>
        </businessRule>
        <businessRule businessRuleType="Extender" name="OS_INTEGRATION_UTILITY">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies>
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_VARIABLES" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_INTEGRATION_GATEWAY" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_Models" />
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="Email_Helper" />
            </referencedAssemblies>
            <sourceCode><![CDATA['-------------------------------------------------------------------------------------------------
'	Version History ==> Date  / Changed By / What Was Changed
'	19th NOV,2021 - vn50tv8 - Added Current user to email Distribution list 
'--------------------------------------------------------------------------------------------------'
Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database

Imports System.Timers 
Imports System.Net
Imports System.Net.Http
Imports System.Threading
Imports System.Threading.Tasks
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq

Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_VARIABLES
Imports OneStream.BusinessRule.Extender.OS_INTEGRATION_GATEWAY
Imports OneStream.BusinessRule.Extender.OS_Models

Namespace OneStream.BusinessRule.Extender.OS_INTEGRATION_UTILITY
	Public Class CommonUtility
		
		#Region "Miscellinaneous"
		Public Shared Function GetAppAndEnvName(ByVal si As sessioninfo) As String
			Return $"{si.AppName} - {GetEnvName()}"
		End Function
		
		Public Shared Function GetCurrentUser(ByVal si As sessioninfo) As String
			Dim fullName = BRApi.Security.Admin.GetUser(si, si.UserName).User.Description
			Return $"{si.UserName} - {fullName}"
		End Function
		
		Public Shared Function GetEnvName() As String
			Dim xEnv As New XFEnvironment
			Dim xEnvSet As XFEnvironmentSettings = xEnv.GetAppServerConfigEnvironmentSettings()
			Return xEnvSet.EnvironmentName
		End Function
		#End Region
		
		#Region "Trigger file creation process"
		Public Shared Function CreateOSTriggerFiles(ByVal si As SessionInfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams)) As List(Of WorkflowBatchFileCollection)
			Dim result = New List(Of WorkflowBatchFileCollection)
			For triggerIndex As Integer = 0 To fcpGateWay.Params.wfTop.Count - 1
				Dim batchInfo As WorkflowBatchFileCollection = TriggerFileProcess(si, fcpGateWay, fcpGateWay.Params.WFTop(triggerIndex), fcpGateWay.Params.WFItem(triggerIndex))
				
				If Not batchInfo Is Nothing Then
					result.Add(batchInfo)
					' push info to the log
					Dim objTimeAppInfo As TimeDimAppInfoEx = BRApi.Finance.Time.GetTimeDimAppInfo(si)
					Dim batchStatusMsg As String = batchInfo.GetCompleteBatchStatusMessage(si,objTimeAppInfo, True, True)					
					
					If fcpGateWay.Params.Debugger Then
						BRapi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - GenerateTriggerFiles - wftop: {fcpGateWay.Params.wfTop(triggerIndex)}, wfItem: {fcpGateWay.Params.wfItem(triggerIndex)}, The batchStatusMsg: {batchStatusMsg}")
					End If 
				Else
					Throw New Exception($"Process: {fcpGateWay.Params.ModuleName} - GenerateTriggerFiles - wftop: {fcpGateWay.Params.wfTop(triggerIndex)}, wfItem: {fcpGateWay.Params.wfItem(triggerIndex)}, Status: Failed, Msg: Could not load data into OneStream as a result of trigger file failure.")
				End If
			Next
			Return result
		End Function
		
		Private Shared Function TriggerFileProcess(ByVal si As SessionInfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams), wfTop As String, wfItem As String) As WorkflowBatchFileCollection
			If fcpGateWay.Params.Debugger Then
				BRApi.ErrorLog.LogMessage(si,$"Process: {fcpGateWay.Params.ModuleName} - TriggerFileProcess - wfTop: {wfTop} , wfItem: {wfItem},  wfScenario: {fcpGateWay.Params.wfScen} , wfTime: {fcpGateWay.Params.wfTime}")
			End If
			
			Dim valTransform As Boolean = True
			Dim valIntersect As Boolean = True
			Dim loadCube As Boolean = True
			Dim processCube As Boolean = True
			Dim confirm As Boolean = False
			Dim autoCertify As Boolean = False
			Dim configSettings As AppServerConfigSettings = AppServerConfig.GetSettings(si)
			
			'Set Processing Switches	
			'Get the profile info
			Dim wfProfileInfo As WorkflowProfileInfo = BRApi.Workflow.Metadata.GetProfile(si, wfTop)
			Dim wfClusterPk As WorkflowUnitClusterPk
			Dim wfClusterPk2 As WorkflowUnitClusterPk
			
			wfClusterPk = BRApi.Workflow.General.GetWorkflowUnitClusterPk(si, wfTop, fcpGateWay.Params.WFScen, fcpGateWay.Params.WFTime)
			
			wfClusterPk2 = BRApi.Workflow.General.GetWorkflowUnitClusterPk(si, $"{wfTop}.{wfItem}", fcpGateWay.Params.WFScen, fcpGateWay.Params.WFTime)
			
			If fcpGateWay.Params.ClearStage Then
			'Clear Stage
				Dim objLoadTransformProcessInfo As LoadTransformProcessInfo = BRApi.Import.Process.ClearStageData(si, wfClusterPk2, Nothing)
			End If
			
			'Check the lock status
			Dim wfStatus As WorkflowInfo = BRApi.Workflow.Status.GetWorkflowStatus(si, wfClusterPk)	
			If Not wfStatus.Locked Then
				Dim harvestPath As String = FileShareFolderHelper.GetBatchHarvestFolderForApp(si, True, configSettings.FileShareRootFolder, configSettings.FileShareBatchHarvestRootFolder, si.AppToken.AppName)
				'Loop through Json is required for Bi Blend Batch File creation.--Rajesh Mirsala.
				If fcpGateWay.Params.ModuleName = "BiBlend" Then 
					CreateBiBlendBatchFileTrigger(si, fcpGateWay, harvestPath, $"{wfTop}",$"{wfItem}")
				Else 
					CreateBatchFileTrigger(si, fcpGateWay, harvestPath, $"{wfTop}.{wfItem}")
				End If
			End If
			
			Dim batchInfo As WorkflowBatchFileCollection = BRApi.Utilities.ExecuteFileHarvestBatch(si, fcpGateWay.Params.wfScen, fcpGateWay.Params.wfTime, valTransform, valIntersect, loadCube, processCube, confirm, autoCertify, False)
			
			If fcpGateWay.Params.Debugger Then
				BRApi.ErrorLog.LogMessage(si,$"Process: {fcpGateWay.Params.ModuleName} - TriggerFileProcess - batchInfo: BatchName:  {batchInfo.GetBatchName}, batchTitleMsg: {batchInfo.GetBatchTitleMessage}")					 			
				 
				'Dim objTimeDimAppInfoEx As TimeDimAppInfoEx = BRApi.Finance.Time.GetTimeDimAppInfo(si)
				'Dim batchStatusMsg As String = batchInfo.GetCompleteBatchStatusMessage(si, objTimeDimAppInfoEx, True, True)
				'BRAPi.ErrorLog.LogMessage(si, "batchStatusMsg:" & batchStatusMsg)
			End If
		
			Return batchInfo
		End Function
		
		Private Shared Sub CreateBatchFileTrigger(ByVal si As SessionInfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams), ByVal harvestPath As String, ByVal wfName As String, ByVal Optional Testing As Boolean = False)
			Dim Path As String = String.Empty

			If Not Testing Then				
				path = harvestPath & "\autoBatchfile-" & wfName & "-" & fcpGateWay.Params.wfScen &  "-" & fcpGateWay.Params.wfTime & "-RB.txt"
			Else
				Dim testingFolderPath As String = BRApi.FileSystem.GetFileShareFolder(si, Filesharefoldertypes.Batch, Nothing) & "\_Testing"
				If Not Directory.Exists(testingFolderPath) Then 
					directory.CreateDirectory(testingFolderPath) 				
				
				End If
				path = testingFolderPath & "\autoBatchfile-" & wfName & "-" & fcpGateWay.Params.wfScen &  "-" & fcpGateWay.Params.wfTime & "-RB.txt"
			End If
				
			If Not File.Exists(path) Or Testing = True Then
				' Create a file to write to. 
				Using sw As StreamWriter = File.CreateText(path)
					sw.WriteLine("Batch File Trigger")
				End Using
			End If
		End Sub
		
		'Looping Month wise and Creating Batch Files to load Data for Months which sent to FCP using JSON. --Rajesh Mirsala.
		Private Shared Sub CreateBiBlendBatchFileTrigger(ByVal si As SessionInfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams), ByVal harvestPath As String, ByVal WfProfileName As String,ByVal wfItemName As String, ByVal Optional Testing As Boolean = False)
			Dim Path As String = String.Empty
			Dim wfName As String
			Dim FPKey As JObject = JObject.parse("")
			Dim dtArray As JArray = FPKey("data")
			Dim FPKeys = dtArray.Select(Function(y) y("Fiscal Period Key")).ToArray()
			
			For Each Key As String In FPKeys
				Dim Yr  = Key.substring(0,4)
				Dim Mth  = Key.substring(4)
				If fcpGateWay.Params.DirectLoad = True Then
					wfName = WfProfileName & "_Per" & Mth & "." & WfItemName & "_Direct"
				Else 	
					wfName = WfProfileName & "_Per" & Mth & "." & WfItemName
				End If
				If Not Testing Then
					If fcpGateWay.Params.WFScen ="Actual" Then
						path = harvestPath & "\autoBatchfile-" & wfName & "-" & fcpGateWay.Params.WFScen &  "-" & Yr &"M"& Mth & "-RB.txt"
					Else
						path = harvestPath & "\autoBatchfile-" & wfName & "-" & fcpGateWay.Params.WFScen &  "-" & fcpGateWay.Params.WFTime & "-RB.txt"
					End If 
				Else
					Dim testingFolderPath As String = BRApi.FileSystem.GetFileShareFolder(si, Filesharefoldertypes.Batch, Nothing) & "\_Testing"
						If Not Directory.Exists(testingFolderPath) Then 
							directory.CreateDirectory(testingFolderPath) 				
						End If
							path = testingFolderPath & "\autoBatchfile-" & wfName & "-" & fcpGateWay.Params.WFScen &  "-" & Yr &"M"& Mth & "-RB.txt"
				End If
			Next
							
			If Not File.Exists(path) Or Testing = True Then
				' Create a file to write to. 
				Using sw As StreamWriter = File.CreateText(path)
					sw.WriteLine("Batch File Trigger")
				End Using
			End If
		End Sub
		
		#End Region
		
		#Region "Send Email"
		
		Public Shared Sub SendMail(ByVal si As sessioninfo, ByVal subject As String, ByVal body As String, ByVal moduleName As String, ByVal moduleParams As IntegrationParams)
			Try
				Dim paramEmailServer As String = BRApi.Dashboards.Parameters.GetLiteralParameterValue(si, False, "prm_WMT_EmailNotification_Server")
				subject = $"{GetAppAndEnvName(si)} - {si.UserName} - " & subject
				AddCurrentUserToEmailDistributionList(si,moduleParams)'DPA-22692/NOV22/Vn50tv8
				brapi.Utilities.SendMail(si, paramEmailServer, moduleParams.EmailDistribution.Split(",").ToList, subject, body, Nothing)	
				
				If moduleParams.Debugger Then
					BRApi.ErrorLog.LogMessage(si,$"Process: {moduleName} - sendmail - Subject: {subject} , Body: {body},  EmailTo: {moduleParams.EmailDistribution}")
				End If
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End	Sub

		Public Shared Sub SendMail(ByVal si As sessioninfo, ByVal subject As String, ByVal body As String, 
								   ByVal emailList As List(Of String), ByVal SubjectDMJobName As String, 
								   Optional batchInfo As WorkflowBatchFileCollection = Nothing)
			
			Try
		        Dim paramEmailServer As String = BRApi.Dashboards.Parameters.GetLiteralParameterValue(si, False, "prm_WMT_EmailNotification_Server")
				
				subject = $"{GetAppAndEnvName(si)} - {si.UserName} " & subject
				AddCurrentUserToEmailDistributionList(si,emailList)'DPA-35062/31dec/2021/vn50tv8
				If Not batchInfo Is Nothing
					Dim emailHelper As New OneStream.BusinessRule.Extender.Email_Helper.MainClass
					emailHelper.GetBatchDetailsAndSendEmail(si, batchInfo, emailList, subject, body, paramEmailServer, SubjectDMJobName)
				Else
					brapi.Utilities.SendMail(si, paramEmailServer, emailList, subject, body, Nothing)	
				End If
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End	Sub
		
		Public Shared Sub SendMail(ByVal si As sessioninfo, ByVal subject As String, ByVal body As String, ByVal moduleParams As FCPPutIntegrationParams, ByVal Optional batchResults As List(Of WorkflowBatchFileCollection) = Nothing)
			Try
				Dim paramEmailServer As String = BRApi.Dashboards.Parameters.GetLiteralParameterValue(si, False, "prm_WMT_EmailNotification_Server")
				
				subject = $"{GetAppAndEnvName(si)} - {si.UserName} " & subject
				Dim emailList As List(Of String) = moduleParams.EmailDistribution.Split(",").ToList()
				AddCurrentUserToEmailDistributionList(si,emailList)'DPA-35062/31dec/2021/vn50tv8
				If Not batchResults Is Nothing
					Dim emailHelper As New OneStream.BusinessRule.Extender.Email_Helper.MainClass
					For Each batchInfo In batchResults
						emailHelper.GetBatchDetailsAndSendEmail(si, batchInfo,  emailList, subject, body, paramEmailServer, moduleParams.ModuleName)
					Next
				Else
					brapi.Utilities.SendMail(si, paramEmailServer, emailList, subject, body, Nothing)	
				End If
			
				If moduleParams.Debugger Then
					BRApi.ErrorLog.LogMessage(si,$"Process: {moduleParams.ModuleName} - sendmail - Subject: {subject} , Body: {body},  EmailTo: {moduleParams.EmailDistribution}")
				End If
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End	Sub
		
		Public Shared Sub SendMail(ByVal si As SessionInfo, ByVal requests As DataTable, ByVal fileAttachmentPaths As List(Of String),
								  ByVal subject As String, ByVal body As String, ByVal appName As String, ByVal paramEmailServer As String, 
								  ByVal distributionList As List(Of String), Optional ByVal err As List(Of String) = Nothing,
								  Optional ByVal wrn As List(Of String) = Nothing, Optional ByVal autoCommit As Boolean = False)
			Try				
				subject = $"{GetAppAndEnvName(si)} - {si.UserName} " & subject
				AddCurrentUserToEmailDistributionList(si,distributionList)'DPA-35062/31dec/2021/vn50tv8
				Dim emailHelper As New OneStream.BusinessRule.Extender.Email_Helper.MainClass
				emailHelper.SendRequestsInitiatedEmail(si, requests, fileAttachmentPaths, subject, body, appName, paramEmailServer, distributionList, err, wrn, autoCommit)
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub
		'DPA-29476/vn50tv8/29thdec -App2App Notifications
		Public Shared Sub SendMail(ByVal si As SessionInfo,ByVal statevalue As String,ByVal moduleParams As IntegrationParams,ByVal moduleName As String,ByVal dictWorkflowInfo As  Dictionary(Of String, String))
			Try
				Dim subject As String = $"{GetAppAndEnvName(si)} - {si.UserName} " 				
				Dim paramEmailServer As String = BRApi.Dashboards.Parameters.GetLiteralParameterValue(si, False, "prm_WMT_EmailNotification_Server")				
				Dim emailList As List(Of String) = moduleParams.EmailDistribution.Split(",").ToList()
				AddCurrentUserToEmailDistributionList(si,emailList)'DPA-35062/31dec/2021/vn50tv8
				 For Each obj As String In emailList
        			 brapi.ErrorLog.LogMessage(si,obj)
      			Next
				Dim emailHelper As New OneStream.BusinessRule.Extender.Email_Helper.MainClass
				emailHelper.GetApp2AppDetailsAndSendEmail(si,statevalue, emailList,subject,dictWorkflowInfo,paramEmailServer) 
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub 
		'19thNov2021 vn50tv8
		Public Shared Sub AddCurrentUserToEmailDistributionList(ByVal si As SessionInfo,ByVal moduleParams As  IntegrationParams)
				' Split string based on comma
				Dim strEmailDistribution As String = moduleParams.EmailDistribution
    			Dim userList As String() = strEmailDistribution.Split(New Char() {","c})
				Dim currentUserEmail = BRApi.Security.Admin.GetUser(si, si.UserName).User.Email
				If Not String.IsNullOrEmpty(currentUserEmail) And Not userList.Contains(currentUserEmail,StringComparer.OrdinalIgnoreCase) Then					 					
					moduleParams.EmailDistribution = strEmailDistribution &","& currentUserEmail	
				End If
		End Sub
		'DPA-35062/31dec/2021/vn50tv8
		Public Shared Sub AddCurrentUserToEmailDistributionList(ByVal si As SessionInfo,ByRef emailDistributionList As List(Of String))
				Dim currentUserEmail = BRApi.Security.Admin.GetUser(si, si.UserName).User.Email
'				brapi.ErrorLog.LogMessage(si,"Count" &emailDistributionList.Count)					
				If Not String.IsNullOrEmpty(currentUserEmail) And Not emailDistributionList.Contains(currentUserEmail,StringComparer.OrdinalIgnoreCase) Then					 					
				   emailDistributionList.Add(currentUserEmail)
				End If
		End Sub
		#End Region
		
		#Region "Process Put with paging"
		
		Public Shared Function QueryForJSON(ByVal si As SessionInfo, ByRef sqlStr As String, Optional RemoveOuterArray As Boolean = True) As String
			Dim rtnStr As String = " "
			
			Try
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
		
						If Not dt Is Nothing Then	
							For Each dr As DataRow In dt.Rows
								rtnStr += dr.Item(0)	
							Next dr
							
							If RemoveOuterArray Then
								rtnStr = rtnStr.Replace(""":[{""r", """:{""r")
								rtnStr = rtnStr.Replace("}]}]", "}]}")
							End If
							Return rtnStr
						Else
							BRAPi.ErrorLog.LogMessage(si, $"QueryForJSON - No dt object returned after ExecuteSQL")	
						End If
					End Using
				End Using
			Catch ex As Exception
				BRApi.ErrorLog.LogMessage(si, $"Exception in QueryForJSON : {ex}")
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
			Return String.Empty
		End Function
		
		Public Shared Function ProcessPutRequest(ByVal si As sessioninfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams), ByVal compiledSql As String, ByVal endPointIndex As Integer, ByVal pageSize As Integer) As Boolean
			Dim success As Boolean = True
			Dim totalPages As Integer? = Nothing
			Dim pageNumber As Integer = 1
			Dim rowOffset As Integer = 0
			Try
				Do
				  	Dim sql = compiledSql.Replace("[ROWOFFSET]", rowOffset).Replace("[PAGENO]", pageNumber)		
					
					If fcpGateWay.Params.Debugger Then
						BRApi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - PageNo: {pageNumber}, SQL: {sql}")		
					End If					
					
					Dim jsonStr As String = QueryForJSON(si, sql)
					If totalPages Is Nothing
						Dim jsonResult As Dictionary(Of String, Object) = JsonConvert.DeserializeObject(Of Dictionary(Of String, Object))(jsonStr)
						totalPages = If(jsonResult.ContainsKey("total_pages"), Convert.ToInt32(jsonResult("total_pages")), 1)
						'FiscalPeriod = If(jsonResult.ContainsKey("API_Fiscal_Period"),jsonResult("API_Fiscal_Period").ToString, String.Empty)
					End If
					
					If fcpGateWay.Params.Debugger Then
						BRApi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - FCP PUT Request for Page: {pageNumber} of {totalPages}")		
					End If	
							
					rowOffset = pageNumber * pageSize
					pageNumber += 1

					Dim response As Task(Of OSJsonResponse) = fcpGateWay.PutData(si, jsonStr, False, OSActionType.Put, endPointIndex)
					Dim result = JsonConvert.DeserializeObject(Of Dictionary(Of String, String))(response.result.JsonData)
					If result("Status").ToLower() <> "success"
						Return False
					End If
				Loop While pageNumber <= totalPages
			Catch ex As Exception
				success = False
				BRapi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - The ProcessPutRequest call exception: {ex}")
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
			Return success
		End Function		
		
		#End Region
		
		#Region "Batch Status"
		Public Shared Function GetBatchStatus(ByVal si As SessionInfo, ByVal fcpGateWay As IntegrationGateway(Of FCPPutIntegrationParams), ByVal batchId As String,  Optional timeoutIntervalMin As Integer = 2, Optional timeoutTotalMin As Integer = 60) As BatchStatus
			'Set to 2 for 2 min, 1 for debug
			Dim tim As New System.Timers.Timer()		

			Dim intervalTime = 60000 * timeoutIntervalMin 

			Dim status As String = String.Empty
						
			AddHandler tim.Elapsed,  New ElapsedEventHandler(
							Sub (ByVal source As Object, ByVal e As ElapsedEventArgs)
							   	Try
									Dim bsResponse As Task(Of OSJsonResponse) = fcpGateWay.GetBatchStatus(si, batchId)
									If fcpGateWay.Params.Debugger Then
										BRApi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - OnTimer: {bsResponse.Result.JsonData}")
									End If
									
									Dim result = JsonConvert.DeserializeObject(Of Dictionary(Of String, String))(bsResponse.result.JsonData)
									status = result("Status").ToString
									If status.ToLower = "finished" OrElse status.ToLower = "failed" Then
									'timer is stopped in the callback because the main-thread and the timer-thread will be racing for the m_status
										tim.Stop()
									End If
									
								Catch ex As Exception
									BRapi.ErrorLog.LogMessage(si, $"Process: {fcpGateWay.Params.ModuleName} - The OnTimer call exception: {ex}")
									Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
								End Try
						   End Sub)
			tim.Interval = intervalTime
			tim.AutoReset = True
			tim.Enabled = True
			tim.Start()
			
			Dim tryCnt = 0
			While  status.ToLower <> "failed" And (status.ToLower <> "finished" And tryCnt < (timeoutTotalMin / timeoutIntervalMin)) 
				Thread.Sleep(intervalTime)
				tryCnt += 1
			End While
			
			'Stop the timer after the timeout
			If tryCnt >= (timeoutTotalMin / timeoutIntervalMin) Then
				tim.Stop()
			End If
			
			tim.Dispose()
			
			Dim bsr As BatchStatus =  BatchStatus.Timeout
			Select  status.ToLower 
				Case "finished" 
					bsr = BatchStatus.Finished
				Case "failed"
					bsr = BatchStatus.Failed
			End Select
			
			Return bsr
		End Function
		#End Region
			
	End Class

End Namespace

]]></sourceCode>
        </businessRule>
        <businessRule businessRuleType="Extender" name="OS_INTEGRATION_VARIABLES">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies>
                <referencedAssembly isInBusinessRulesAssemblyFolder="false" isOtherBusinessRule="true" isInEnvironmentSpecialFolder="false" environmentSpecialFolder="" assemblyName="OS_Models" />
            </referencedAssemblies>
            <sourceCode><![CDATA[Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database

Imports NewtonSoft.Json

Imports OneStream.BusinessRule.Extender.OS_Models

Namespace OneStream.BusinessRule.Extender.OS_INTEGRATION_VARIABLES
	
	Public Class IntegrationParamProviderFactory
		
		Public Shared FCPModules As List(Of OSModuleType) = New List(Of OSModuleType) ({ OSModuleType.FCP, OSModuleType.DIMENSION, OSModuleType.FX, OSModuleType.FCPPut })
		
		Public Function GetProvider(ByVal si As SessionInfo, ByVal moduleName As String, ByVal moduleType As OSModuleType, Optional ByVal args As ExtenderArgs = Nothing) As IParamProvider
			Select moduleType
				Case OSModuleType.FCP
					Return New FCPIntegrationParamProvider(si, moduleName)
				Case OSModuleType.CC
					Return New CCParamProvider(si, moduleName)
				Case OSModuleType.FX
					Return New FXRatesParamProvider(si, moduleName)
				Case OSModuleType.DIMENSION
					Return New FCPDimensionParamProvider(si, moduleName)
				Case OSModuleType.FCPPut
					Return New FCPPutParamProvider(si, args)
				Case Else
					Return New IntegrationParamProvider()
			End Select
		End Function
		
	End Class
	
	#Region "IParamProvider"
	Public Interface IParamProvider
		ReadOnly Property Params() As IntegrationParams
		Function GetParmValue(ByVal si As SessionInfo, ByVal moduleName As String,ByVal action As String,ByVal paramName As String) As String
	End Interface 
	#End Region
	
	#Region "Parameter Provider Definitions"
	
	#Region "IntegrationParamProvider"
	
	Public Class IntegrationParamProvider
		Implements IParamProvider
		
		Private _integrationParams As IntegrationParams
		Public Overridable ReadOnly Property Params() As IntegrationParams Implements IParamProvider.Params
			Get
				Return _integrationParams
			End Get
		End Property
		
		 Public Function GetParmValue(ByVal si As SessionInfo, ByVal moduleName As String, ByVal action As String,ByVal paramName As String) As String Implements IParamProvider.GetParmValue
		 	Dim result As String
			Try 
				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module = '" & moduleName &"' AND AppName = '"  & si.AppName & "' AND Action = '"  & action & "' AND ParmName = '"  & paramName & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
						result = dt.AsEnumerable().FirstOrDefault()("ParmValue")
					End Using
				End Using
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
			Return result
	    End Function
		
	End Class
	
	#End Region
	
	#Region "FCPIntegrationParamProvider"
	
	Public Class FCPIntegrationParamProvider
		Inherits IntegrationParamProvider
		
		Private _integrationParams As FCPIntegrationParams
		
		Public Sub New(ByVal si As SessionInfo, ByVal moduleName As String)
			Try
				' connect to the database 
				' read all of the parameters from for the arg ModuleName
				
				#Region "DB Params"

				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module = '" & moduleName &"' AND AppName = '"  & si.AppName & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
						_integrationParams = dt.AsEnumerable() _
												.GroupBy(Function(dr) dr("Module")) _
												.Select(Function(grp) New With { _
													.Params = (From item In grp
															  Let l_endPoint = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONEndPoint"))
															  Let l_emailDist = grp.Where(Function(gdr) gdr("ParmName").Equals("EmailDist")).FirstOrDefault()
															  Let l_consumerId = grp.Where(Function(gdr) gdr("ParmName").Equals("ConsumerID")).FirstOrDefault()
															  Let l_svcName = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcName")).FirstOrDefault()
															  Let l_svcEnv = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcEnv")).FirstOrDefault()
															  Select New FCPIntegrationParams With _ 
															  { 
																 .EndPoint = If(l_endPoint Is Nothing, New Dictionary(Of String, Dictionary(Of Integer, String))(), l_endPoint.GroupBy(Function(dr) dr("Action")).ToDictionary(Function(k) k.Key.ToString, Function(v) v.ToDictionary(Function(vk) Convert.ToInt32(vk("SeqNum")), Function(vv) vv("ParmValue").ToString))),
																 .EmailDistribution = If(l_emailDist Is Nothing, "", l_emailDist("ParmValue")),
																 .ConsumerId = If(l_consumerId Is Nothing, "", l_consumerId("ParmValue")),
																 .SvcName = If(l_svcName Is Nothing, "", l_svcName("ParmValue")),
																 .SvcEnv = If(l_svcEnv Is Nothing, "", l_svcEnv("ParmValue"))
															  }).FirstOrDefault()
												}).First().Params
												
					End Using
				End Using
				
				#End Region
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub
		
		Public Overrides ReadOnly Property  Params() As IntegrationParams
			Get
				Return _integrationParams
			End Get
		End Property
	End Class
		
	#End Region
	
	#Region "CCParamProvider"
	
	Public Class CCParamProvider
		Inherits IntegrationParamProvider
		
		Private _ccParams As CCParams

	    Public Sub New(ByVal si As SessionInfo, ByVal moduleName As String)
			Try
				#Region "Database Params"
				' connect to the database 
				' read all of the parameters from for the arg ModuleName
				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module IN ('CommandCenter', '" & moduleName &"') AND AppName = '"  & si.AppName & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
						_ccParams = dt.AsEnumerable() _
												.GroupBy(Function(dr) dr("Module").ToString.Split(New Char() {"_"c})(0)) _
												.Select(Function(grp) New With { _
													.Module = grp.Key, 
													.Params = (From item In grp
															  Let l_endPoint = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONEndPoint"))
															  Let l_emailDist = grp.Where(Function(gdr) gdr("ParmName").Equals("EmailDist")).FirstOrDefault()
															  Let l_debugger = grp.Where(Function(gdr) gdr("ParmName").Equals("Debugger")).FirstOrDefault()
															  Let l_retry = grp.Where(Function(gdr) gdr("ParmName").Equals("RetryCount")).FirstOrDefault()
															  Let l_dmuNames = grp.Where(Function(gdr) gdr("ParmName").Equals("DMUNames")).FirstOrDefault()
															  Select New CCParams With _ 
															  { 
																 .EndPoint = If(l_endPoint Is Nothing, New Dictionary(Of String, Dictionary(Of Integer, String))(), l_endPoint.GroupBy(Function(dr) dr("Action")).ToDictionary(Function(k) k.Key.ToString, Function(v) v.ToDictionary(Function(vk) Convert.ToInt32(vk("SeqNum")), Function(vv) vv("ParmValue").ToString))),
																 .EmailDistribution = If(l_emailDist Is Nothing, "", l_emailDist("ParmValue")),
																 .Debugger = If(l_debugger Is Nothing, False, Convert.ToBoolean(l_debugger("ParmValue"))),
																 .RetryCount = If(l_retry Is Nothing, 3, Convert.ToInt32(l_retry("ParmValue"))),
																 .DMUNames = If(l_dmuNames Is Nothing, "", l_dmuNames("ParmValue"))
															  }).FirstOrDefault()
												}).First().Params
												
					End Using
				End Using
				#End Region
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try

	    End Sub
		
		Public Overrides ReadOnly Property Params() As IntegrationParams
			Get
				Return _ccParams
			End Get
		End Property
 
	End Class	
		
	#End Region
	
	#Region "FXRatesParamProvider"
	
	Public Class FXRatesParamProvider
		Inherits IntegrationParamProvider
		
		Private _fxParams As FXRatesParams

	    Public Sub New(ByVal si As SessionInfo, ByVal moduleName As String)
			Try
				#Region "Database Params"
				' connect to the database 
				' read all of the parameters from for the arg ModuleName
				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module IN ('CommandCenter', '" & moduleName &"') AND AppName = '"  & si.AppName & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
						_fxParams = dt.AsEnumerable() _
												.GroupBy(Function(dr) dr("Module").ToString.Split(New Char() {"_"c})(0)) _
												.Select(Function(grp) New With { _
													.Module = grp.Key, 
													.Params = (From item In grp
															  Let l_endPoint = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONEndPoint"))
															  Let l_emailDist = grp.Where(Function(gdr) gdr("ParmName").Equals("EmailDist")).FirstOrDefault()
															  Let l_debugger = grp.Where(Function(gdr) gdr("ParmName").Equals("Debugger")).FirstOrDefault()
															  Let l_retry = grp.Where(Function(gdr) gdr("ParmName").Equals("RetryCount")).FirstOrDefault()
															  Let l_osRatePeriod = grp.Where(Function(gdr) gdr("ParmName").Equals("OsRatePeriod")).FirstOrDefault()
															  Let l_ruleGroupName = grp.Where(Function(gdr) gdr("ParmName").Equals("RuleGroupName")).FirstOrDefault()
															  Select New FXRatesParams With _ 
															  { 
																 .EndPoint = If(l_endPoint Is Nothing, New Dictionary(Of String, Dictionary(Of Integer, String))(), l_endPoint.GroupBy(Function(dr) dr("Action")).ToDictionary(Function(k) k.Key.ToString, Function(v) v.ToDictionary(Function(vk) Convert.ToInt32(vk("SeqNum")), Function(vv) vv("ParmValue").ToString))),
																 .EmailDistribution = If(l_emailDist Is Nothing, "", l_emailDist("ParmValue")),
																 .Debugger = If(l_debugger Is Nothing, False, Convert.ToBoolean(l_debugger("ParmValue"))),
																 .RetryCount = If(l_retry Is Nothing, 3, Convert.ToInt32(l_retry("ParmValue"))),
																 .OsRatePeriod = If(l_osRatePeriod Is Nothing, "", l_osRatePeriod("ParmValue")),
																 .RuleGroupName = If(l_ruleGroupName Is Nothing, "", l_ruleGroupName("ParmValue"))
															  }).FirstOrDefault()
												}).First().Params
												
					End Using
				End Using
				#End Region
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try

	    End Sub
		
		Public Overrides ReadOnly Property Params() As IntegrationParams
			Get
				Return _fxParams
			End Get
		End Property
 
	End Class
		
	#End Region
	
	#Region "FCPDimensionParamProvider"
	
	Public Class FCPDimensionParamProvider
		Inherits IntegrationParamProvider
		
		Private _dimensionParams As FCPDimensionParams
			
		Public Sub New(ByVal si As SessionInfo, ByVal moduleName As String)
			Try
				' connect to the database 
				' read all of the parameters from for the arg ModuleName
				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module = '" & moduleName &"' AND AppName = '"  & si.AppName & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)

						_dimensionParams = dt.AsEnumerable() _
												.GroupBy(Function(dr) dr("Module")) _
												.Select(Function(grp) New With { _
													.Params = (From item In grp
															  Let l_endPoint = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONEndPoint"))
															  Let l_emailDist = grp.Where(Function(gdr) gdr("ParmName").Equals("EmailDist")).FirstOrDefault()
															  Let l_consumerId = grp.Where(Function(gdr) gdr("ParmName").Equals("ConsumerID")).FirstOrDefault()
															  Let l_svcName = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcName")).FirstOrDefault()
															  Let l_svcEnv = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcEnv")).FirstOrDefault()
															  Let l_dimension = grp.Where(Function(gdr) gdr("ParmName").Equals("Names")).FirstOrDefault()
															  Let l_AppNames = grp.Where(Function(gdr) gdr("ParmName").Equals("AppNames")).FirstOrDefault()
															  Select New FCPDimensionParams With _ 
															  { 
																 .EndPoint = If(l_endPoint Is Nothing, New Dictionary(Of String, Dictionary(Of Integer, String))(), l_endPoint.GroupBy(Function(dr) dr("Action")).ToDictionary(Function(k) k.Key.ToString, Function(v) v.ToDictionary(Function(vk) Convert.ToInt32(vk("SeqNum")), Function(vv) vv("ParmValue").ToString))),
																 .EmailDistribution = If(l_emailDist Is Nothing, "", l_emailDist("ParmValue")),
																 .ConsumerId = If(l_consumerId Is Nothing, "", l_consumerId("ParmValue")),
																 .SvcName = If(l_svcName Is Nothing, "", l_svcName("ParmValue")),
																 .SvcEnv = If(l_svcEnv Is Nothing, "", l_svcEnv("ParmValue")),
																 .Dimension= If(l_dimension Is Nothing, "", l_dimension("ParmValue")),
																 .AppNames = If(l_AppNames Is Nothing, "", l_AppNames("ParmValue"))
															  }).FirstOrDefault()
												}).First().Params
												
					End Using
				End Using
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub

		Public Overrides ReadOnly Property Params() As IntegrationParams
			Get
				Return _dimensionParams
			End Get
		End Property

	End Class
		
	#End Region
	
	#Region "FCPPutParamProvider"
	
	Public Class FCPPutParamProvider
		Inherits IntegrationParamProvider
		
		Private _integrationParams As FCPPutIntegrationParams
		
		Public Sub New(ByVal si As SessionInfo, ByVal args As ExtenderArgs)
			Try
				Dim argParams = New FCPPutIntegrationParams()
			
				#Region "Args Params"
				' *** get the argument info ***
				If Not args.NameValuePairs.ContainsKey("ModuleName") Then
					Throw ErrorHandler.LogWrite(si, New XFException(si, "DMJOb parameter ModuleName is Required", ""))
				End If
				argParams.ModuleName = args.NameValuePairs("ModuleName")
				
				If Not args.NameValuePairs.ContainsKey("WFScen") Then
					Throw ErrorHandler.LogWrite(si, New XFException(si, "DMJOb parameter WFScen is Required", ""))
				End If
				argParams.WFScen = args.NameValuePairs("WFScen")
				
				If Not args.NameValuePairs.ContainsKey("WFTime") Then
					Throw ErrorHandler.LogWrite(si, New XFException(si, "DMJOb parameter WFTime is Required", ""))
				End If
				argParams.WFTime = args.NameValuePairs("WFTime")
				
				If args.NameValuePairs.ContainsKey("Debug") Then
					argParams.Debugger = CBool(args.NameValuePairs("Debug"))
					Else
						argParams.Debugger = False
				End If
				
				If args.NameValuePairs.ContainsKey("AppEnv") Then
						argParams.AppEnv = args.NameValuePairs("AppEnv")
					Else
						argParams.AppEnv = si.AppName
				End If
				'Workflow Name set to Direct Load instead of Import,Validate and Load
				If args.NameValuePairs.ContainsKey("DirectLoad") Then
					argParams.DirectLoad = CBool(args.NameValuePairs("DirectLoad"))
					Else
						argParams.DirectLoad = False
				End If
								
				If args.NameValuePairs.ContainsKey("ClearStage") Then
					argParams.ClearStage = CBool(args.NameValuePairs("ClearStage"))
				Else
					argParams.ClearStage = False
				End If
				
				If args.NameValuePairs.ContainsKey("SupplyMethod") Then
					argParams.SupplyMethod = args.NameValuePairs("SupplyMethod")
					Else
						argParams.DirectLoad = ""
				End If
								
				If args.NameValuePairs.ContainsKey("SupplyAcct") Then
					argParams.SupplyAcct = args.NameValuePairs("SupplyAcct")
				Else
					argParams.SupplyAcct = ""
				End If
				
				#End Region	
				
				#Region "DB Params"

				Dim sqlStr As String = "Select * FROM XFT_Global_Parameters Where Module = '" & argParams.ModuleName &"' AND AppName = '"  & argParams.AppEnv & "' ORDER BY ParmName, Action, SeqNum"
				Using dbConnApp As DBConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					Using dt As DataTable = BRAPi.Database.ExecuteSql(dbConnApp, sqlStr, True)
						_integrationParams = dt.AsEnumerable() _
												.GroupBy(Function(dr) dr("Module")) _
												.Select(Function(grp) New With { _
													.Params = (From item In grp
															  Let l_endPoint = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONEndPoint"))
															  Let l_jsonSql = grp.Where(Function(gdr) gdr("ParmName").Equals("JSONSql"))
															  Let l_wfTop = grp.Where(Function(gdr) gdr("ParmName").Equals("WFTop"))
															  Let l_wfItem = grp.Where(Function(gdr) gdr("ParmName").Equals("WFItem"))
															  Let l_emailDist = grp.Where(Function(gdr) gdr("ParmName").Equals("EmailDist")).FirstOrDefault()
															  Let l_consumerId = grp.Where(Function(gdr) gdr("ParmName").Equals("ConsumerID")).FirstOrDefault()
															  Let l_svcName = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcName")).FirstOrDefault()
															  Let l_svcEnv = grp.Where(Function(gdr) gdr("ParmName").Equals("SvcEnv")).FirstOrDefault()
															  Select New FCPPutIntegrationParams With _ 
															  { 
																 .EndPoint = If(l_endPoint Is Nothing, New Dictionary(Of String, Dictionary(Of Integer, String))(), l_endPoint.GroupBy(Function(dr) dr("Action")).ToDictionary(Function(k) k.Key.ToString, Function(v) v.ToDictionary(Function(vk) Convert.ToInt32(vk("SeqNum")), Function(vv) vv("ParmValue").ToString))),
																 .JsonSql =If(l_jsonSql Is Nothing, New  Dictionary(Of Integer, String), l_jsonSql.ToDictionary(Function(k) Convert.ToInt32(k("SeqNum")), Function(v) v("ParmValue").ToString)),
																 .WFTop =If(l_wfTop Is Nothing, New  Dictionary(Of Integer, String), l_wfTop.ToDictionary(Function(k) Convert.ToInt32(k("SeqNum")), Function(v) v("ParmValue").ToString)),
																 .WFItem =If(l_wfItem Is Nothing, New  Dictionary(Of Integer, String), l_wfItem.ToDictionary(Function(k) Convert.ToInt32(k("SeqNum")), Function(v) v("ParmValue").ToString)),
																 .EmailDistribution = If(l_emailDist Is Nothing, "", l_emailDist("ParmValue")),
																 .ConsumerId = If(l_consumerId Is Nothing, "", l_consumerId("ParmValue")),
																 .SvcName = If(l_svcName Is Nothing, "", l_svcName("ParmValue")),
																 .SvcEnv = If(l_svcEnv Is Nothing, "", l_svcEnv("ParmValue"))
															  }).FirstOrDefault()
												}).First().Params
												
					End Using
				End Using
				
				#End Region
				
				#Region "Consolidate Params"
				_integrationParams.ModuleName = argParams.ModuleName
				_integrationParams.WFScen = argParams.WFScen	
				_integrationParams.WFTime = argParams.WFTime
				_integrationParams.Debugger = argParams.Debugger
				_integrationParams.DirectLoad = argParams.DirectLoad 
				_integrationParams.AppEnv = argParams.AppEnv
				_integrationParams.ClearStage = argParams.ClearStage
				#End Region
								
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub
		
		Public Overrides ReadOnly Property  Params() As IntegrationParams
			Get
				Return _integrationParams
			End Get
		End Property
	End Class
		
	#End Region
	
	#End Region
	
	#Region "Parameter Model Definitions"
	
	#Region "IntegrationParams"
	Public Class IntegrationParams

		Private m_endPoint As Dictionary(Of String, Dictionary(Of Integer, String))

		Private m_emailDist As String
		Private m_debugger As Boolean 
		Private m_retryCount As Integer

		Public Property EndPoint() As Dictionary(Of String, Dictionary(Of Integer, String))
			Get
				Return m_endPoint
			End Get
			Set
				m_endPoint = value
			End Set
		End Property
		
		Public Property EmailDistribution() As String
			Get
				Return m_emailDist
			End Get
			Set
				m_emailDist = value
			End Set
		End Property
		
				
		Public Property Debugger() As Boolean
			Get
				Return m_debugger
			End Get
			Set
				m_debugger = value
			End Set
		End Property
		
		Public Property RetryCount() As Integer
			Get
				Return m_retryCount
			End Get
			Set
				m_retryCount = value
			End Set
		End Property
	End Class

	#End Region
	
	#Region "FCPIntegrationParams"
	
	Public Class FCPIntegrationParams 
		Inherits IntegrationParams
		
		Private m_ConsumerId As String 
		Private m_SvcName As String
		Private m_SvcEnv As String
		
		Public Property ConsumerId() As String
			Get
				Return m_ConsumerId
			End Get
			Set
				m_ConsumerId = value
			End Set
		End Property
		
		Public Property SvcName() As String
			Get
				Return m_SvcName
			End Get
			Set
				m_SvcName = value
			End Set
		End Property
		
		Public Property SvcEnv() As String
			Get
				Return m_SvcEnv
			End Get
			Set
				m_SvcEnv = value
			End Set
		End Property
	End Class
	
	#End Region
	
	#Region "CommandCenterParams"
	Public Class CCParams
		Inherits IntegrationParams

		Private m_dmuNames As String
		
		Public Property DMUNames() As String
			Get
				Return m_dmuNames
			End Get
			Set
				m_dmuNames = value
			End Set
		End Property
	End Class
	#End Region
	
	#Region "FXRatesParams"
	Public Class FXRatesParams
		Inherits FCPIntegrationParams

		Private m_OsRatePeriod As String
		Private m_RuleGroupName As String

		Public Property OsRatePeriod() As String
			Get
				Return m_OsRatePeriod
			End Get
			Set
				m_OsRatePeriod = value
			End Set
		End Property
		
		Public Property RuleGroupName() As String
			Get
				Return m_RuleGroupName
			End Get
			Set
				m_RuleGroupName = value
			End Set
		End Property
	End Class
	#End Region
	
	#Region "FCPDimensionParams"
	
	Public Class FCPDimensionParams 
		Inherits FCPIntegrationParams	
		
		Private m_Dimension As String
		Private m_AppNames As String 
		
		Public Property Dimension() As String
			Get
				Return m_Dimension
			End Get
			Set
				m_Dimension = value
			End Set
		End Property
		
		Public Property AppNames() As String
			Get
				Return m_AppNames
			End Get
			Set
				m_AppNames = value
			End Set
		End Property	
	End Class
	
	#End Region
	
	#Region "PutIntegrationParams"
	Public Class FCPPutIntegrationParams
		Inherits FCPIntegrationParams
		
		Private m_moduleName As String
		Public Property ModuleName As String
			Get
				Return m_moduleName
			End Get
			Set
				m_moduleName = value
			End Set
		End Property
		
		Private m_wfScen As String
		Public Property WFScen As String
			Get
				Return m_wfScen
			End Get
			Set
				m_wfScen = value
			End Set
		End Property
		
		Private m_wfTime As String
		Public Property WFTime As String
			Get
				Return m_wfTime
			End Get
			Set
				m_wfTime = value
			End Set
		End Property
		
		Private m_appEnv As String
		Public Property AppEnv As String
			Get
				Return m_appEnv
			End Get
			Set
				m_appEnv = value
			End Set
		End Property
		
		Private m_clearStage As Boolean
		Public Property ClearStage As Boolean
			Get
				Return m_clearStage
			End Get
			Set
				m_clearStage = value
			End Set
		End Property
		
		Private m_directLoad As Boolean
		Public Property DirectLoad As Boolean
			Get
				Return m_directLoad
			End Get
			Set
				m_directLoad = value
			End Set
		End Property
		
		Private m_WFTop As Dictionary(Of Integer, String)  
		Public Property WFTop() As Dictionary(Of Integer, String)
			Get
				Return m_WFTop
			End Get
			Set
				m_WFTop = value
			End Set
		End Property
		
		Private m_JsonSql As Dictionary(Of Integer, String)  
		Public Property JsonSql() As Dictionary(Of Integer, String)
			Get
				Return m_JsonSql
			End Get
			Set
				m_JsonSql = value
			End Set
		End Property
		
		Private m_WFItem As Dictionary(Of Integer, String)  
		Public Property WFItem() As Dictionary(Of Integer, String)
			Get
				Return m_WFItem
			End Get
			Set
				m_WFItem = value
			End Set
		End Property
		
		Private m_supplyMethod As String
		Public Property SupplyMethod As String
			Get
				Return m_supplyMethod
			End Get
			Set
				m_supplyMethod = value
			End Set
		End Property
		
		Private m_supplyAcct As String
		Public Property SupplyAcct As String
			Get
				Return m_supplyAcct
			End Get
			Set
				m_supplyAcct = value
			End Set
		End Property
	End Class
	#End Region
	
	#End Region
	
End Namespace]]></sourceCode>
        </businessRule>
        <businessRule businessRuleType="Extender" name="OS_Models">
            <accessGroup>Everyone</accessGroup>
            <maintenanceGroup>Everyone</maintenanceGroup>
            <isGlobal>false</isGlobal>
            <isEncrypted>false</isEncrypted>
            <referencedAssemblies />
            <sourceCode><![CDATA[Imports System
Imports System.Data
Imports System.Data.Common
Imports System.IO
Imports System.Collections.Generic
Imports System.Globalization
Imports System.Linq
Imports Microsoft.VisualBasic
Imports System.Windows.Forms
Imports OneStream.Shared.Common
Imports OneStream.Shared.Wcf
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Database
Imports OneStream.Stage.Engine
Imports OneStream.Stage.Database
Imports OneStream.Finance.Engine
Imports OneStream.Finance.Database

Namespace OneStream.BusinessRule.Extender.OS_Models
	
	#Region "ResponseStatus"
	<Serializable> _
	Public Class ResponseStatus 		
		Private m_Success As Boolean
		Private m_StatusCode As String
		Private m_ReasonPhrase As String
		Private m_FcpRecordCount As Integer
		Private m_OsRecordCount As Integer
		Private m_Url As String
		
		Public Sub New()
			m_Success = True
		End Sub
		
		Public Sub New(success As Boolean, status As Integer, reason As String, Optional fcpRecordCount As Integer = 0, Optional osRecordCount As Integer = 0)
			m_Success = success
			m_StatusCode = status
			m_ReasonPhrase = reason
			m_FcpRecordCount = fcpRecordCount
			m_OsRecordCount = osRecordCount
		End Sub

		Public Property Success() As Boolean
			Get
				Return m_Success
			End Get
			Set
				m_Success = value
			End Set
		End Property

		Public Property StatusCode() As String
			Get
				Return m_StatusCode
			End Get
			Set
				m_StatusCode = value
			End Set
		End Property
		
		Public Property ReasonPhrase() As String
			Get
				Return m_ReasonPhrase
			End Get
			Set
				m_ReasonPhrase = value
			End Set
		End Property
		
		Public Property FcpRecordCount() As Integer
			Get
				Return m_FcpRecordCount
			End Get
			Set
				m_FcpRecordCount = value
			End Set
		End Property
		
		Public Property OsRecordCount() As Integer
			Get
				Return m_OsRecordCount
			End Get
			Set
				m_OsRecordCount = value
			End Set
		End Property
		
		Public Property Url() As String
			Get
				Return m_Url
			End Get
			Set
				m_Url = value
			End Set
		End Property
	End Class
	#End Region	
	
	#Region "ActualsData"
	Public Class ActualsData
		Inherits ResponseStatus

		Private m_DataTable As DataTable 
		
		Public Property Data() As DataTable
			Get
				FcpRecordCount = If(m_DataTable Is Nothing, 0, m_DataTable.Rows.Count)
				Return m_DataTable
			End Get
			Set
				m_DataTable = value
			End Set
		End Property
	End Class
	#End Region
	
	#Region "ActualsJsonData"
	Public Class ActualsJsonData
		Inherits ResponseStatus

		Private m_JsonData As String
		
		Public Property JsonData() As String
			Get
				Return m_JsonData
			End Get
			Set
				m_JsonData = value
			End Set
		End Property
		
	End Class
	
	#End Region
	
	#Region "OSJsonResponse"
	Public Class OSJsonResponse
		Inherits ResponseStatus
		
		Private m_JsonData As String
		
		Public Property JsonData() As String
			Get
				Return m_JsonData
			End Get
			Set
				m_JsonData = value
			End Set
		End Property
	End Class
	
	#End Region
	
	#Region "Enum OSActionType"
	Public Enum OSActionType
		[Get]
		Put
		Guid
		Status
		Trigger	
	End Enum
	#End Region
	
	#Region "Enum OSModuleType"
	Public Enum OSModuleType
		FCP
		CC
		DIMENSION
		FX
		ACM
		FCPPut
	End Enum
	#End Region
	
	#Region "Enum BatchStatus"
		Public Enum BatchStatus
			Timeout
			Finished
			Failed
		End Enum
	#End Region
	
End Namespace
]]></sourceCode>
        </businessRule>
    </extensibilityRulesRoot>
</OneStreamXF>